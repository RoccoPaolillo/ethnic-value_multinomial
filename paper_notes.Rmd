---
output:
  bookdown::pdf_document2:
    toc: false
 #   keep_tex: false
    fig_caption: yes
title: "Paper notes"
author: Rocco Paolillo
bibliography: "references.bib"
# csl: apa.csl # by default: Chicago style
header-includes:
- \usepackage{float}
- \usepackage{multirow}
- \usepackage{xcolor} 
- \usepackage{amsmath}
---

\newcommand{\rocco}[1]{\textcolor{red}{{Rocco:}#1}} <!-- <- this is a command to appear in pdf -->
<!-- command not to appear in pdf -->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.lp="fig:")

library(Hmisc)
library(ggplot2)

# Here functions that are used.

# Calculation ethnic utility (for each option)
# i_e: ethnic threshold (ideal point)
# M: right-side slope
# x: number agents in neighborhood with same color
# n: total number agents in neighborhood
# S: left-side slope
# Note: if (x > n){U <- NA} to show the case number of agents in neighborhood different from 8, so that utility is calculated based on this, although x-axis in graph has 8 points  (excluded from calculation)

f_eth <- function(i_e,M,x,n,S){
  if (x > n){
    U <- NA}else{
  if (x < round(n*i_e,digits = 2)){
   U <- (x / round((n*i_e),digits = 2)) * S
    }else if (x > round((n*i_e),digits = 2)){
      U <- M + ((1- (x/n))*(1-M))/(1-i_e)   
    }else{
        U <- 1}
  round(U,digits = 2)
    }
}

# Calculation value utility (for each option)

f_val <- function(e_w,ew_ng,M,i_v,S){
  if (round(abs(e_w-ew_ng), digits=2) <= i_v) {
    U <- 1
    }else{
      U <- (M + ((1-(round(abs(e_w-ew_ng), digits=2)))*(1-M))/(1-i_v)) * S
    }
  round(U,digits = 2)
}

# Probability (random utility with logistic regression) to relocate

prob <- function(d_u_e,d_u_v,e_w,par_v){round(1 / (1 + exp(-(e_w*10)*(d_u_e) + (-(v_w*10)*(d_u_v)))),digits= 2)}

# install.packages("tinytex", repos = "https://cloud.r-project.org" ) if debug needed?

```


Write down how the three types of functions (Zhang, Schelling, new -> symmetric, threshold, costant) can be built out of the parameters M and S. Make a graph


aaaa


```{r graph function include=TRUE, echo=FALSE}



# f2 <- function(p,M,x,n,S)

i_e = 0.5
M = 0
S = 1
n = 8

f0s <- f_eth(i_e,M,0,n,S)
f1s <- f_eth(i_e,M,1,n,S)
f2s <- f_eth(i_e,M,2,n,S)
f3s <- f_eth(i_e,M,3,n,S)
f4s <- f_eth(i_e,M,4,n,S)
f5s <- f_eth(i_e,M,5,n,S)
f6s <- f_eth(i_e,M,6,n,S)
f7s <- f_eth(i_e,M,7,n,S)
f8s <- f_eth(i_e,M,8,n,S)

i_e = 0.5
M = 1
S = 1
n = 8

f0c <- f_eth(i_e,M,0,n,S)
f1c <- f_eth(i_e,M,1,n,S)
f2c <- f_eth(i_e,M,2,n,S)
f3c <- f_eth(i_e,M,3,n,S)
f4c <- f_eth(i_e,M,4,n,S)
f5c <- f_eth(i_e,M,5,n,S)
f6c <- f_eth(i_e,M,6,n,S)
f7c <- f_eth(i_e,M,7,n,S)
f8c <- f_eth(i_e,M,8,n,S)


i_e = 0.5
M = 1
S = 0
n = 8

f0t <- f_eth(i_e,M,0,n,S)
f1t <- f_eth(i_e,M,1,n,S)
f2t <- f_eth(i_e,M,2,n,S)
f3t <- f_eth(i_e,M,3,n,S)
f4t <- f_eth(i_e,M,4,n,S)
f5t <- f_eth(i_e,M,5,n,S)
f6t <- f_eth(i_e,M,6,n,S)
f7t <- f_eth(i_e,M,7,n,S)
f8t <- f_eth(i_e,M,8,n,S)

Utility_S <- c(f0s,f1s,f2s,f3s,f4s,f5s,f6s,f7s,f8s)
Utility_C <- c(f0c,f1c,f2c,f3c,f4c,f5c,f6c,f7c,f8c)
Utility_T <- c(f0t,f1t,f2t,f3t,f4t,f5t,f6t,f7t,f8t)


# name_E <- paste0("Desired proportion i = ",i_e,"; M = ",M,"; S = ",S)
# plot(num_sim_col,Utility_T, xlab = "Similar ethnics neighborhood j", ylab = "Ethnic Utility",  main = "Ethnic Utility for neighborhood j of agent i",  sub = name_E)
# report_E <- paste0("M = ",M,"; S = ",S,"; Desired proportion i = ",i_e,"; Similar ethnics neighborhood j = ", seq(0, 8, by = 1), "; Utility ij = ", Utility_T)
# print(report_E)


# func_type <- c(rep("symmetric",9),rep("constant",9),rep("threshold",9))

x_graph <- rep(seq(0, 8, by = 1),3)
funct_symm <- c(rep("symmetric",9),rep("constant",9),rep("threshold",9))
utility_location <- c(Utility_S,Utility_C,Utility_T)

A <- data.frame(x_graph[c(0:9)],utility_location[c(0:9)],funct_symm[c(0:9)])


A

# write.csv2(A,file="C:/Users/rocpa/OneDrive/Desktop/08_08_2019/ethnic-value_multinomial/data_utility")

A_graph <- ggplot(A,aes(x_graph[c(0:9)],utility_location[c(0:9)])) 

A_graph + geom_point()

A_graph + geom_point(aes(colour = funct_symm, shape= funct_symm, size = funct_symm)) + scale_size_manual(values = c(4,5,3)) + scale_shape_manual(values = c(19,19,19)) + scale_color_manual(values = c("darkorchid","forestgreen","black"))



```

```{r overlap_function include=TRUE, echo=FALSE}


x_graph_overlap <- rep(seq(0, 100, by = 12.5),4)

S_0 <- c(0,0,0,0,0,NA,NA,NA,NA)
M_1 <- c(NA,NA,NA,NA,1,1,1,1,1)
S_1 <- c(0,0.25,0.5,0.75,1,NA,NA,NA,NA)
M_0 <- c(NA,NA,NA,NA,1,0.75,0.5,0.25,0)  # should be 0.75 and 0.24, I think due to round(U)2 in the function


funct_overlap <- c(rep("S = 0",9),rep("M = 1",9),rep("S = 1",9),rep("M = 0",9))
utility_overlap <- c(S_0,M_1,S_1,M_0)

overlap <- data.frame(x_graph_overlap,utility_overlap,funct_overlap)


# overlap

graph_overlap <- ggplot(overlap,aes(x_graph_overlap,utility_overlap))

suppressWarnings(print(
graph_overlap + geom_line(aes(colour = funct_overlap)) + scale_color_manual(values = c("red","forestgreen","black","purple"),name = "Parameters Setting") + theme_bw() + labs(x = "percentage similars",y = "utility for location")
))


```

Ethnic utility, separating ethnic_weight and ideal payoff for ethnicity (i_e) -> based on ethnicity of agents (color)
The ethnic weight follows the beta distribution, *maybe* report Blitzstein 4 beta cases, and anyway considering ethnic_weight and value_weight are complementary

Specify n > x <- U:NA in formula



```{r ethnic utility individual-run include=TRUE, echo=FALSE}


# f2 <- function(p,M,x,n,S)

i_e = 0.5
M = 0
S = 1
n = 8

f0m <- f_eth(i_e,M,0,n,S)
f1m <- f_eth(i_e,M,1,n,S)
f2m <- f_eth(i_e,M,2,n,S)
f3m <- f_eth(i_e,M,3,n,S)
f4m <- f_eth(i_e,M,4,n,S)
f5m <- f_eth(i_e,M,5,n,S)
f6m <- f_eth(i_e,M,6,n,S)
f7m <- f_eth(i_e,M,7,n,S)
f8m <- f_eth(i_e,M,8,n,S)

num_sim_col <- seq(0, 8, by = 1)
Utility_E <- c(f0m,f1m,f2m,f3m,f4m,f5m,f6m,f7m,f8m)
name_E <- paste0("Desired proportion i = ",i_e,"; M = ",M,"; S = ",S)

plot(num_sim_col,Utility_E, xlab = "Similar ethnics neighborhood j", ylab = "Ethnic Utility",  main = "Ethnic Utility for neighborhood j of agent i",  sub = name_E)

report_E <- paste0("M = ",M,"; S = ",S,"; Desired proportion i = ",i_e,"; Similar ethnics neighborhood j = ", seq(0, 8, by = 1), "; Utility ij = ", Utility_E)

print(report_E)

```

















```{r ethnic_utility, moore neighborhood, include=TRUE, echo=FALSE}


# f2 <- function(p,M,x,n,S)

#i_e = 0.5
M = 0
S = 1
n = 8

for (i_e in seq (0.0,1.0, by = 0.1)){
  
f0m <- f_eth(i_e,M,0,n,S)
f1m <- f_eth(i_e,M,1,n,S)
f2m <- f_eth(i_e,M,2,n,S)
f3m <- f_eth(i_e,M,3,n,S)
f4m <- f_eth(i_e,M,4,n,S)
f5m <- f_eth(i_e,M,5,n,S)
f6m <- f_eth(i_e,M,6,n,S)
f7m <- f_eth(i_e,M,7,n,S)
f8m <- f_eth(i_e,M,8,n,S)

num_sim_col <- seq(0, 8, by = 1)
Utility_E <- c(f0m,f1m,f2m,f3m,f4m,f5m,f6m,f7m,f8m)
name_E <- paste0("Desired proportion i = ",i_e,"; M = ",M,"; S = ",S)

plot(num_sim_col,Utility_E, xlab = "Similar ethnics neighborhood j", ylab = "Ethnic Utility",  main = "Ethnic Utility for neighborhood j of agent i",  sub = name_E)

report_E <- paste0("M = ",M,"; S = ",S,"; Desired proportion i = ",i_e,"; Similar ethnics neighborhood j = ", seq(0, 8, by = 1), "; Utility ij = ", Utility_E)

print(report_E)

}
```

Value utility, based on agents' desired distance (i_v) between the agent's ethnic_weight (e_w) and neighborhood's average ethnic_weight (calculated out of agents residing there)
Calculate ethnic weight average of neighborhoods with n agents > 0.


 **check:** Explain how S and M vary for the constant function, the comment seems lost

```{r value_similarity, echo=FALSE, }

i_v <- 0
S  <- 1
M <- 0

for (e_w in seq (0.0,1.0, by = 0.1)){

fv0d2 <- f_val(e_w,0,M,i_v,S)
fv1d2 <- f_val(e_w,0.1,M,i_v,S)
fv2d2 <- f_val(e_w,0.2,M,i_v,S)
fv3d2 <- f_val(e_w,0.3,M,i_v,S)
fv4d2 <- f_val(e_w,0.4,M,i_v,S)
fv5d2 <- f_val(e_w,0.5,M,i_v,S)
fv6d2 <- f_val(e_w,0.6,M,i_v,S)
fv7d2 <- f_val(e_w,0.7,M,i_v,S)
fv8d2 <- f_val(e_w,0.8,M,i_v,S)
fv9d2 <- f_val(e_w,0.9,M,i_v,S)
fv10d2 <- f_val(e_w,1.0,M,i_v,S)

value_mean_neighborhood <- seq(0.0, 1.0, by = 0.1)
Utility_V <- c(fv0d2,fv1d2,fv2d2,fv3d2,fv4d2,fv5d2,fv6d2,fv7d2,fv8d2,fv9d2,fv10d2)
name_V <- paste0("Ethnic weight i = ", e_w,"; desired distance i = ",i_v,"; M = ",M,"; S = ",S)

plot(value_mean_neighborhood,Utility_V, xlab = "Mean ethnic weight neighborhood j", ylab = "Value Utility neighborhood j",  main = "Value Utility for neighborhood j of agent i",  sub = name_V)

report_v <- paste0(name_V,"; Mean ethnic weight j = ", seq(0.0, 1.0, by = 0.1), "; Utility ij = ", Utility_V)

print(report_v)

}

```

Once calculated the ethnic utility and value utility, apply prob above (logistic function) in the decision rule of the agent, with prob(to_new) >= random-float 0-1


```{r logistic putting as in abm ethnic_weight, value_weight}

for (d_u_e in seq (-1.0,1.0, by = 0.1)){
  
e_w <- 0.8
v_w <- 1 - e_w

# d_u_e <- -1

  dis_0   <- prob(d_u_e,0.0,e_w,v_w)
dis_0.1 <- prob(d_u_e,0.1,e_w,v_w)
dis_0.2 <- prob(d_u_e,0.2,e_w,v_w)
dis_0.3 <- prob(d_u_e,0.3,e_w,v_w)
dis_0.4 <- prob(d_u_e,0.4,e_w,v_w)
dis_0.5 <- prob(d_u_e,0.5,e_w,v_w)
dis_0.6 <- prob(d_u_e,0.6,e_w,v_w)
dis_0.7 <- prob(d_u_e,0.7,e_w,v_w)
dis_0.8 <- prob(d_u_e,0.8,e_w,v_w)
dis_0.9 <- prob(d_u_e,0.9,e_w,v_w)
dis_1   <- prob(d_u_e,1.0,e_w,v_w)
dis_0.1neg <- prob(d_u_e,-0.1,e_w,v_w)
dis_0.2neg <- prob(d_u_e,-0.2,e_w,v_w)
dis_0.3neg <- prob(d_u_e,-0.3,e_w,v_w)
dis_0.4neg <- prob(d_u_e,-0.4,e_w,v_w)
dis_0.5neg <- prob(d_u_e,-0.5,e_w,v_w)
dis_0.6neg <- prob(d_u_e,-0.6,e_w,v_w)
dis_0.7neg <- prob(d_u_e,-0.7,e_w,v_w)
dis_0.8neg <- prob(d_u_e,-0.8,e_w,v_w)
dis_0.9neg <- prob(d_u_e,-0.9,e_w,v_w)
dis_1neg   <- prob(d_u_e,-1.0,e_w,v_w)
  
  value_difference <- seq(-1.0,1.0, by = 0.1)
  prob_relocation <- seq(0.0, 1.0,  by = 0.1)
  
  prob_choice <- c(dis_1neg,dis_0.9neg,dis_0.8neg,dis_0.7neg,dis_0.6neg,dis_0.5neg,dis_0.4neg,dis_0.3neg,dis_0.2neg,dis_0.1neg,dis_0,dis_0.1,dis_0.2,dis_0.3,dis_0.4,dis_0.5,dis_0.6,dis_0.7,dis_0.8,dis_0.9,dis_1)
  
  name_diff <- paste0("Note: "," Ethnic parameter = ", e_w*10," ;"," Value parameter = ", v_w*10, 
                      "\r\n Utility Difference -1 = MIN Utility Alternative, 1 = MAX Utility Alternative")
  
  name_diff_title <-paste0("Probability to move to alternative","\r\n Difference Ethnic Utility (Alternative - Current) = ", d_u_e)
  
plot(value_difference,prob_choice, xlab = "x-axis: Difference Value Utility (Alternative - Current) \r\n",ylab = "probability", main = name_diff_title, sub = name_diff,ylim = c(0,1), yaxt = 'n')
axis(2,at=seq(0.0, 1.0, by = 0.25))

}


```





```{r logistic in sequence, to test with parameters, to be deleted}

prob <- function(d_u_e,d_u_v,par_e,par_v){round(1 / (1 + exp(-par_e*(d_u_e) + (-par_v*(d_u_v)))),digits= 2)}

for (d_u_e in seq (-1.0,1.0, by = 0.1)){
  
par_e <- 10
par_v <- 10 - par_e

# d_u_e <- -1

  dis_0p   <- prob(d_u_e,0.0,par_e,par_v)
dis_0.1p <- prob(d_u_e,0.1,par_e,par_v)
dis_0.2p <- prob(d_u_e,0.2,par_e,par_v)
dis_0.3p <- prob(d_u_e,0.3,par_e,par_v)
dis_0.4p <- prob(d_u_e,0.4,par_e,par_v)
dis_0.5p <- prob(d_u_e,0.5,par_e,par_v)
dis_0.6p <- prob(d_u_e,0.6,par_e,par_v)
dis_0.7p <- prob(d_u_e,0.7,par_e,par_v)
dis_0.8p <- prob(d_u_e,0.8,par_e,par_v)
dis_0.9p <- prob(d_u_e,0.9,par_e,par_v)
dis_1p  <- prob(d_u_e,1.0,par_e,par_v)
dis_0.1negp <- prob(d_u_e,-0.1,par_e,par_v)
dis_0.2negp <- prob(d_u_e,-0.2,par_e,par_v)
dis_0.3negp <- prob(d_u_e,-0.3,par_e,par_v)
dis_0.4negp <- prob(d_u_e,-0.4,par_e,par_v)
dis_0.5negp <- prob(d_u_e,-0.5,par_e,par_v)
dis_0.6negp <- prob(d_u_e,-0.6,par_e,par_v)
dis_0.7negp <- prob(d_u_e,-0.7,par_e,par_v)
dis_0.8negp <- prob(d_u_e,-0.8,par_e,par_v)
dis_0.9negp <- prob(d_u_e,-0.9,par_e,par_v)
dis_1negp   <- prob(d_u_e,-1.0,par_e,par_v)
  
  value_difference <- seq(-1.0,1.0, by = 0.1)
  prob_relocation <- seq(0.0, 1.0,  by = 0.1)
  
  prob_choicep <- c(dis_1negp,dis_0.9negp,dis_0.8negp,dis_0.7negp,dis_0.6negp,dis_0.5negp,dis_0.4negp,dis_0.3negp,dis_0.2negp,dis_0.1negp,dis_0p,dis_0.1p,dis_0.2p,dis_0.3p,dis_0.4p,dis_0.5p,dis_0.6p,dis_0.7p,dis_0.8p,dis_0.9p,dis_1p)
  
  name_diff <- paste0("Note: "," Ethnic parameter = ", par_e," ;"," Value parameter = ", par_v, 
                      "\r\n Utility Difference -1 = MIN Utility Alternative, 1 = MAX Utility Alternative")
  
  name_diff_title <-paste0("Probability to move to alternative","\r\n Difference Ethnic Utility (Alternative - Current) = ", d_u_e)
  
plot(value_difference,prob_choicep, xlab = "x-axis: Difference Value Utility (Alternative - Current) \r\n",ylab = "probability", main = name_diff_title, sub = name_diff,ylim = c(0,1), yaxt = 'n')
axis(2,at=seq(0.0, 1.0, by = 0.25))

}


```







# Component of probability of the choice

- Object of choice: neighborhood
- Choice: relocate to a neighborhood
- Utility: payoff one is likely to accept to make the choice, i.e. to relocate to one neighborhood (or stay on current one). In @zhang2004 it is made up of:
  - deterministic component $U$: how much people desire/value one preference  in order to make the choice as ideal payoff, e.g. degree of ethnic concentration (e.g. max utility = 1 at 100% similars). @zhang2004 uses a single-peaked function (vs maximization).
  - random term $\epsilon$ that refers to other characteristics of the option, i.e. the neighborhood, that influence the choice but independent of utility payoff. In regression models  this is the random  error terms. Random utility models in abm recreate with the exponential function, so that not always the best option according to the deterministic component $U$ is chosen.
- Probability of the choice: $\beta u (.) + \epsilon$\, which is conceptually different but related to payoff $u$
  - $\beta$ is a parameter indicating how much the characteristic of the option is important in the probability to make a choice, or the random term $\epsilon$. It is modeled as a positive constant: the lower is $\beta$, the higher is random term $\epsilon$, i.e. other random characteristics, are relevant to choose one neighborhood. The higher is $\beta$, the lower will be the importance of random term $\epsilon$ and higher the importance of deterministic utility component to make a choice, i.e. moving to the neighborhood.
\



# Aim of the paper

- Independent of the ideal payoff $u$ people have for one characteristic of the neighborhood, my question is why someone should give more importance to that characteristic over the others, that is:
\par
why should $\beta$ vary among individuals?
\par
An answer in @esser2010 is social, educational, economic capital and how it translates into the investment of people into receiving context/ethnic context and his general suggestion. For instance:
  - The lower an agent speaks a language, the higher the need for aggregating with co-ethnics would be, so to increase $\beta_{ethnic}$ independently of what is the ideal payoff for ethnic composition of the neighborhood;
  - the higher is social mobility intention either as investment or value in the own community, the higher the wealth (socio-economic status) of the neighborhood would be $\beta_{status}$
  - the higher the need to associate with people sharing the same values of local community (receiving context in Esser [@esser2010] (e.g. political orientations, norm beliefs...) even as strategy for crossing ethnic boundaries [@wimmer2013], the higher the composition of value-orientation would become with increase of $\beta_{value}$ 
- Costs of relocation can be included as costs that hinder relocation despite the choice. This can be one application of  @esser2010's definition of costs as limit to the investment on the receving context option. In @esser2010 costs is loosely derived from social, economic and cultural capital milieu and are basically conceptualized upon the concrete choice actors (i.e. migrants) want to engage in, costs of relocation can be one of many.

- In the ACS paper [@paolillo2018] we focused on the interplay of different homophily preferences in Schelling's threshold model and diffent type of segregation that emerge. With this direction the next paper could link to the ACS paper [@paolillo2018] by:
  * addressing the reason why people would have preference for one characteristic over the other
  * what's the effect of people holding different preferences at same grades, while in the ACS they were exclusive tolerant: value, intolerant: ethnicity
  * extension to the random utility model as in @zhang2004 would distinguish between the ideal payoff $u$ for a characteristic and how important is that characteristic to people $\beta$
  * an additional point to random utility models would be to link $\beta$ to needs and resources of people as in @esser2010. This has some advantages to me:
    - relative group size and ethnic boundary making in @esser2010 are supposed to influence probability to make a choice.In the ACS paper we included symbolic boundaries through the definition of similarity and relative group size, now we would include the overall frame of the model with need $\rightarrow$ change in $\beta$) and costs of relocation
    - as in the original Schelling [@schelling1969;@schelling1971] and other literature, homophily *per se* is a mechanism which describes the aggregation dynamics, but it does not provide causal mechanism on why people should aggregate based on one dimension over the others. This frame of the paper could fill this point
    - foster the linkage between @esser2010's speculation and Schelling's model, so to benefit the long term agenda of the project
    - deeper definition of utility frame and rational choice, linking to the literature in abm and concretisize @esser2010's model itself, which was elaborated as a summa of general and abstract rational choice

- Linking $\beta$ to needs and including costs, $\beta u (.) + \epsilon$ should become something like $$N_{e} U_{e} + N_{v} U_{v} + N_{s} U_{s} - C$$ where $N$ =  needs, $C$ = costs and $e,v,s$ the ethnic, value and socio-economic status dimension. The random term $\epsilon$ is implemented through the exponential function.

# Notes on the model

- Now agents' characteristics of ethnicity, value and ses are nested. I think it would be worth to have a change in $u$ and $\beta$ for any intersection, but with risk to increase the number of parameters. The simplest solution I found so far was to link it to the value-orientation of agents as in the ACS paper [@paolillo2018].

- A way to reduce the number of parameters and make the model more realistic might be to have $u$ changing as function of the identification agents hold for the three categories (value, ethnicity and ses), changing the categories to a gradient $-1 ...+1$, e.g.:
  - value: extreme right-wing $\longleftrightarrow$ extreme leftwing, or pro local norms $\longleftrightarrow$ vs local norms.
  - ses: extrem low $\longleftrightarrow$ extreme high
  - ethnicity: dychotomous group 1 vs group 2
This way would maybe allow to explore more with fewer parameters: 
  - ideal payoff function $u$ as in the single-peaked function could derive from how people positionate along the continuum, as well combination of different homophily preferences. Assuming value as tolerance towards diversity, people extremely conservative would likely want in their neighborhood people both of the same ethnic group, but also of the same value orientation. People in the middler positions would care less about the value-orientation of others (as in the current ACS paper)
  - the model would be relaxated which would justify the single-peaked function, linking $u$ to  shift in $M$ and affect the right slope: people who aim at 100% similar neighborhood would be more likely to choose a 90% similar neighborhood than 30%, as well as people aiming at a mixed 50% neighborhood would be more likely to choose a 60% of similar, as in Zhang [@zhang2004]
  - different and more realistic scenarios, and examples in literature could be compared [@van2012] or what data show. This supports  the aim of the abm/project to clarify how different scenarios of integration/segregation are possible in an unified model and theory building


I implemented in the model the single-peaked funcition as in @zhang2004 since I think it allows to explore more articulated scenarios. I think it would be worth to question about as above.

$$
U=
\begin{cases}
\frac{x}{np}, & \text{if} \ x \leq np, \\
(2Z-M)+\frac{(M-Z)x}{np}, & otherwise
\end{cases}
$$



Assuming $Z=1$ as peak of utility at desired fraction $P$, then the equation becomes as follow. This is how I implemented  for the three utilities (ethnicity, value, ses). Did not understand to be honest how the second equation @zhang2004 (otherwise) is reduced to the one used  in Andreas Flache's slides and Sage's model (how 2Z-M disappears). I adapted their equation, but I  understand it and it works as I tested.

$$
U=
\begin{cases}
\frac{x}{np}, & \text{if} \ x \leq np, \\
M+\frac{(1-(x/n))*(1-M)}{(1-p)}, & otherwise
\end{cases}
$$
\

where
M = constant for the right slope \
x = number of similar ones in Moore neighborhood \
n = number of agents in the Moore neighborhod $\rightarrow$ x/n: fraction similars \
p = desired concentration \

Fig. \ref{fig:moore} replicates @zhang2004 for desired fraction $p=0.5$ in an 8 patches Moore neighborhood, $Z=1$ and $M=0.6$.\
Fig  \ref{fig:sechneg} shows how the function will not change for the same proportion within a different number of patches occupied in the neighborhood, here with occupied patches equal to 6.\
Fig. \ref{fig:emmeone} shows how for M=1 utility becomes constant once the ideal payoff is reached, kind similar to threshold models\
Fig. \ref{fig:emmezero} shows how for M=0 the right slope is symmetrical with left one.

Fig. \ref{fig:utzero} shows the condition where desired concentration $p=0$ in a 8 patches neighborhoood, with $M=0.6$, which means agents actively do not want any similar in the neighborhood. This means that although utility = 1 at 0 is not possible, the function becomes linear decreasing.\
Fig. \ref{fig:integr} shows how this translates in the  model with $\beta=100$. Seems to me it increases stable integration, and it is not an error: as @zhang2004 describes, with $\beta=0$ agents just move randomly, with equal chance to move to alternative patch or stay in neighborhood. Here with $\beta=100$ the characteristic of the neighborhood is relevant to them, although the payoff is 0 and $\beta * u=0$, correct I think conceptually and as the stable patterns of emerged segregations and average utility show. To check if this can be related to @bruch2006's error cited by @van2009





```{r sechneg, echo=FALSE, fig.cap="utility in Moore 6 patches; desired fraction 50%, M=0.6, Z=1"}

# f0t6 <- f(0.5,0.6,0,6)
# f1t6 <- f(0.5,0.6,1,6)
# f2t6<- f(0.5,0.6,2,6)
# f3t6 <- f(0.5,0.6,3,6)
# f4t6 <- f(0.5,0.6,4,6)
# f5t6 <- f(0.5,0.6,5,6)
# f6t6 <- f(0.5,0.6,6,6)

# utilityt6 <- c(f0t6,f1t6,f2t6,f3t6,f4t6,f5t6,f6t6)
# concentrationt6 <- c(0:6)


# print(utilityt8)
# plot(concentrationt6,utilityt6)

```



```{r emmeone, echo=FALSE, fig.cap="utility in Moore 8 patches; desired fraction 50%, M=1, Z=1"}



# f0m <- f(0.5,1,0,8)
# f1m <- f(0.5,1,1,8)
# f2m <- f(0.5,1,2,8)
# f3m <- f(0.5,1,3,8)
# f4m <- f(0.5,1,4,8)
# f5m <- f(0.5,1,5,8)
# f6m <- f(0.5,1,6,8)
# f7m <- f(0.5,1,7,8)
# f8m <- f(0.5,1,8,8)

# utility_Moore <- c(f0m,f1m,f2m,f3m,f4m,f5m,f6m,f7m,f8m)
# concentrationm <- c(0:8)


# print(utilitym)
# plot(concentrationm,utility_Moore)
```

```{r emmezero, echo=FALSE, fig.cap="utility in Moore 8 patches; desired fraction 50%, M=0, Z=1"}



# f0m <- f(0.5,0,0,8)
# f1m <- f(0.5,0,1,8)
# f2m <- f(0.5,0,2,8)
# f3m <- f(0.5,0,3,8)
# f4m <- f(0.5,0,4,8)
# f5m <- f(0.5,0,5,8)
# f6m <- f(0.5,0,6,8)
# f7m <- f(0.5,0,7,8)
# f8m <- f(0.5,0,8,8)

# utility_Moore <- c(f0m,f1m,f2m,f3m,f4m,f5m,f6m,f7m,f8m)
# concentrationm <- c(0:8)


# print(utilitym)
# plot(concentrationm,utility_Moore)
```





# Doubts


* It is still not very clear to me what you can get out of a regression model for what concerns utility. Some material I am reading describes dependent variable y as the probability to choose option x, and assumes this to be expression of the term utility quantified in beta coefficient times variable(characteristic) for each characteristic. But following @zhang2004, utility of the option made per se would be already the product of $\beta$ probability of choice * $u$ ideal payoff. I do not understand if it is possible to disentangle the two components from a regression, although intuitive cases come to mind (e.g. finding negative correlation between costs in @esser2010 and probability of choice). @borghans2015 use the deviance of betas related to difference within groups, which I understand how to connect to multinomial choice as differences in choice due to characteristics of people, but it is not to my doubt. It is how to disentangle utility in empirical terms which is not very clear to me, and how the modeling choice can be related to empirical data, or if I am overthinking on it. In  any case I would need to study more.

* Some models as @zhang2004 and @bruch2006 put random utility models within Schelling's framework. As I understand so far there  are different components that collapse as multinomial choice, single-peaked function etc. In general they seems to me to fit within utility perspective, but it is not clear to me how much these utility models conceptually fit in @schelling1969 threshold model they cite or are innerly different. In my understanding a threshold model would not care about the left-slope of a single-peaked function, and utility would be constant as @bruch2006 also describes. There would be not consideration of (random) probabilities but prob = 1 once threshold is guaranteed, despite adding randomness, and not assessment of different options, as in the white flight. I think there is a difference conceptually and it should be marked. I also wonder how much a threshold model and utility models would differ when compared with empirical data and how they could be compared, which many abm paper do not focus on. I would like to study this as well, would make sense considering the ACS paper is a threshold model and now shifting to utility, but I think it would be beyond this paper. In general for my PhD I have to wite a paper of my onw.

<!-- read @Brock2001, @Brock1997 -->

# References
