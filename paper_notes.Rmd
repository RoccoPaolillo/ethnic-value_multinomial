---
output:
  bookdown::pdf_document2:
    toc: false
 #   keep_tex: false
    fig_caption: yes
title: "Paper notes"
subtitle: "Target: BIGSSS Research Day"
author: Rocco Paolillo
date: "`r  as.Date(Sys.time(), '%d %m %Y')`" 
language: en-GB
bibliography: "references.bib"
always_allow_html: yes

# target: BIGSSS Research Day by September 15th, presented  on October 25th. 6000 words: around 12 pages.
# csl: apa.csl # by default: Chicago style
header-includes:
- \usepackage{float}
- \usepackage{multirow}
- \usepackage{xcolor} 
- \usepackage{amsmath}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.lp="fig:",warning = FALSE)

# install.packages("tinytex", repos = "https://cloud.r-project.org" )



library(knitr)
library(Hmisc)
library(ggplot2)
library(gridExtra)
library(ggpubr)
library(dplyr)
library(grid)
library(ggrepel)
library(magicfor)
library(dplyr)
library(plot3D)
library(rgl)
library(plotly)
library(tidyr)
library(plyr)
library(rgl)
library(graphics)
library(cowplot)
library(magick) 
library(xtable)


# Calculation ethnic utility

  f_eth <- function(i_e,M,x,n,S){
   if (x > n){
     U <- NA}else{
     if (x < (n*i_e)){
   U <- (x / (n*i_e)) * S
      }else if (x > (n*i_e)){
         U <- M + ((1- (x/n))*(1-M))/(1-i_e) 
        }else{
     U <- 1}
        round(U,digits = 3)
      }
 }


# Calculation value utility

f_val <- function(e_w,ew_ng,i_v,S_v){
  if (round(abs(e_w-ew_ng), digits=2) <= i_v) {
    U <- 1
    }else{
      U <- ((1-(round(abs(e_w-ew_ng), digits=2)))/(1-i_v)) * S_v
      }
  round(U,digits = 3)
  }
 

# Ethnic utility difference and value utility difference

magic_for(print,silent = TRUE)

for (i in seq (-1.0,1.0, by = 0.1)){
  eth_diff <- rep(i,21)
  print(eth_diff)
}

d_u_e <-  magic_result_as_vector()
d_u_v <- rep(seq(-1,1,by = 0.1),21)

dfprob <- data.frame(d_u_e,d_u_v,e_w=0,v_w=0,k=0)


# Probability to move to alternative (random utility with logistic regression) 

prob <- function(d_u_e,d_u_v,e_w,v_w,k){round(1 / (1 + exp((-(e_w*k)*(d_u_e)) + (-(v_w*k)*(d_u_v)))),digits= 2)}
# prob <- function(d_u_e,d_u_v,e_w,v_w,k){1 / (1 + exp((-(e_w*k)*(d_u_e)) + (-(v_w*k)*(d_u_v))))}

# prob <- function(d_u_e,d_u_v,e_w,v_w,k){round(1 / (1 + exp(-(e_w*k)*(d_u_e)) + -(v_w*k)*(d_u_v)),digits= 2)}


# For the 3D plots

prob_3d <- function(b){
  fx <- d_u_e
  fy <- d_u_v
  fz <- b$prob
  
  tit <- paste0("Ethnic weight = ",b$e_w*b$k,"; ","Value weight = ",b$v_w*b$k, "\n\r -1:MIN Alternative, 1:MAX Alternative")
 
   tridi_prob <- plot_ly(x=fx,y=fy,z=fz, type="scatter3d", color=fz, mode="markers")  %>% 
    layout(scene = list(
       xaxis = list(title = "x = Diff. Ethnic Ut."),
       yaxis = list(title = "y = Diff. Value Ut."),
       zaxis = list(title = "z = Probability")
     ), 
     annotations = (list(x = 0.5, y = 1, text = tit, showarrow = F, font=list(size=18)
     ))
   ) %>% hide_colorbar() 

 tridi_prob 

 }

# install.packages("tinytex", repos = "https://cloud.r-project.org" ), try if debug needed

```





In the agent-based model, an agent chooses between current location and one alternative location according to the ethnic utility and value utility attributed to neighborhoods. The aim is to fit the random utility framework for a discrete choice model and advance on the ACS paper [@paolillo2018]. I liked  @bruch2009preferences's description disentangling between utility, probability and how they relate in the empirical data / agent-based models relation.

Probability that an agent will choose the alternative relies on the difference between the utility of the two neighborhood options:

$$
P_{alterntive}=U_{alternative} -  U_{current}
$$
Where: \par
- $P_{alternative}=1$ means moving to alternative, implying its utility is higher than the current one
- $P_{alternative}=0$ means staying on the current location, implying its utility is higher than alternative

Definition of utility for a neighborhood, and its implication for the probability to relocate, fits the random utility framework: 

$$
U^i_{(ej,yj)}   = \beta_ee_j + \beta_vv_j + \epsilon_j
$$

With $\beta_e$ being the importance of ethnic composition $e_j$ of neighborhood $j$, $\beta_v$ the importance of its value composition $v_j$, and $\epsilon_j$ the random term. The random term refers to other characteristics of neighborhoods or of decision makers that can influence the utility and probability of choice, but that are totally unknown. $\beta$ regulates the systematic component of utility, and $\epsilon$ the random component of utility [@bruch2009preferences]. Random component is assumed to be independent and identically distributed (i.i.d.) among options, while the systematic component of utility depends on the formalized functional form and how it interacts with $\beta$ values. This condition allows that the higher is the parameter $\beta \in[0,\infty)$, the lower is the effect of random term and the more the utility derived from one option depends on their characteristics (here ethnic and value composition) and how they interact with the functional forms of utility implemented. The probability to choose one option over the others relies on the difference of utility so computed, with the option with the highest utility being selected. As a consequence, for high $\beta \in[0,\infty)$, the probability will depend on the systematic component of utility, selecting the best option. For low levels of $\beta$, the probability will be random due to the higher component of the random term.

In this implementation of the model, $beta_x$ follows a beta distribution. To avoid confusion between terms of parameter beta and beta distribution used in the simulation, $\beta_x$ is called ethnic weight $ew$ (e_w in R code), $\beta_y$ is called value weight $vw$ (v_w in R code), with $v_w = 1-e_w$.

Following @zhang2011, and also @bruch2006, we want to implement and compare the consequences of adopting different functional forms in the definition of utility as individual behavior of agents. In particular, we want to compare a range of functional forms of individual behavior spanning from the single-peaked function as in @zhang2011[ graphic p. 174] to the threshold function as in the original Schelling's model and that we used in the ACS paper [@paolillo2018]. The idea was a third function as a combination between linear growing as in @zhang2011 until the ideal point (proportion of similars) is reached, and then constant for higher proportions that include the ideal point as it would be in Schelling.

Since the task was to reduce number of parameters as much and reproduce the functions we need, I modified @zhang2011's formula, assuming max Utility = 1 and introducing S parameter that combined with M generates the functions we need:\par
- $S[0,1]$, regulates the increasing left slope 
- $M[0,1]$, regulates the decreasing right slope (same in Zhang)

# Ethnic Utility {-}

$$
U^i_e=
\begin{cases}
1, & \text{if} x =  n\times i_e, \\
\\
(\frac{x}{n \times i_e})\times S, & \text{if} \ x < n\times i_e, \\
\\
M + \frac{(1 - \frac{x}{n}) \times (1 - M)}{1 - i_e}, & \text{if} \ x > n\times i_e 
\end{cases}
$$

Where: \par
- $U^i_e$: Ethnic utility of agent i
- $x$: number of similar agents in the neighborhood
- $n$: total number of agents in the neighborhood
- $i_e$: desired ethnic composition

Fig.\ref{fig:ethnicf} reports the example of the three functions, and how $S$ and $M$ are set to calculate them. The example refers to desired compostion $50\%$ ($i_e = 0.5$). It was calculated out of a 8 agents neighborhood (with 4 agents of same ethnicity representing the $50 \%$), I changed the units on x-axis to percentage.

*IDEA/DOUBT*: A fourth function we could include is for S=0 and M=0. In a computational framework,the aim of the paper is to explore and formalize the consequences of different functional forms, which represent different behaviors of how people attribute utility to a neighborhood, whatever might be the reason for this. Following this I think there would be no need to exclude one scenario out of the set and would be more sound to compare the four exteme cases. As in fig. \ref{fig:ethnicf}:\par
- S=1,M=0, the symmetric single-peaked function with ideal point: people have a preference they value maximally, and devalue equally options that are below or above such preference
- S=1,M=1, people increasingly value options below their ideal point as long as they get closer to it, and are equally happy for those  options that include and guarantee the ideal point
- S=0,M=1, the original threshold Schelling: people have a threshold preference, devalue and refuse (Utility = 0) options below it and are equally happy for those above it
- S=0,M=0 (to add): people devalue and refuse any option below their ideal point (Utility = 0), and decreasingly devalue those options that exceed their ideal point

```{r ethnicf, fig.width=6,fig.height= 8, fig.align="center", fig.pos="H",include=TRUE, echo=FALSE, fig.cap = "Ethnic Utility Function"}
     
i_e = 0.5                   # definition of parameters for each function: i_e desired ethnic concentration
M = 0                       # M: right-side slope, S: left-side slope, n = total number of agents in neighborhood
S = 1
n = 8

f0s <- f_eth(i_e,M,0,n,S)     # computation for each neighborhood, the increasing number is number of  similars
f1s <- f_eth(i_e,M,1,n,S)
f2s <- f_eth(i_e,M,2,n,S)
f3s <- f_eth(i_e,M,3,n,S)
f4s <- f_eth(i_e,M,4,n,S)
f5s <- f_eth(i_e,M,5,n,S)
f6s <- f_eth(i_e,M,6,n,S)
f7s <- f_eth(i_e,M,7,n,S)
f8s <- f_eth(i_e,M,8,n,S)

i_e = 0.5
M = 1
S = 1
n = 8

f0c <- f_eth(i_e,M,0,n,S)
f1c <- f_eth(i_e,M,1,n,S)
f2c <- f_eth(i_e,M,2,n,S)
f3c <- f_eth(i_e,M,3,n,S)
f4c <- f_eth(i_e,M,4,n,S)
f5c <- f_eth(i_e,M,5,n,S)
f6c <- f_eth(i_e,M,6,n,S)
f7c <- f_eth(i_e,M,7,n,S)
f8c <- f_eth(i_e,M,8,n,S)


i_e = 0.5
M = 1
S = 0
n = 8

f0t <- f_eth(i_e,M,0,n,S)
f1t <- f_eth(i_e,M,1,n,S)
f2t <- f_eth(i_e,M,2,n,S)
f3t <- f_eth(i_e,M,3,n,S)
f4t <- f_eth(i_e,M,4,n,S)
f5t <- f_eth(i_e,M,5,n,S)
f6t <- f_eth(i_e,M,6,n,S)
f7t <- f_eth(i_e,M,7,n,S)
f8t <- f_eth(i_e,M,8,n,S)

# here below to make up for dataframe and plots

Utility_S <- c(f0s,f1s,f2s,f3s,f4s,f5s,f6s,f7s,f8s)                     
Utility_C <- c(f0c,f1c,f2c,f3c,f4c,f5c,f6c,f7c,f8c)
Utility_T <- c(f0t,f1t,f2t,f3t,f4t,f5t,f6t,f7t,f8t)

x_graph <- rep(seq(0, 100, by = 12.5),3)
funct_symm <- c(rep("symmetric",9),rep("constant",9),rep("threshold",9))
utility_location <- c(Utility_S,Utility_C,Utility_T)

symmetric <- data.frame(x_graph[c(0:9)],utility_location[c(0:9)],funct_symm[c(0:9)])
constant <- data.frame(x_graph[c(10:18)],utility_location[c(10:18)],funct_symm[c(10:18)])
threshold <- data.frame(x_graph[c(19:27)],utility_location[c(19:27)],funct_symm[c(19:27)])

symmetric_graph <- ggplot(symmetric,aes(x_graph[c(0:9)],utility_location[c(0:9)])) 
constant_graph <- ggplot(constant,aes(x_graph[c(10:18)],utility_location[c(10:18)])) 
threshold_graph <- ggplot(threshold,aes(x_graph[c(19:27)],utility_location[c(19:27)])) 

subt_cont_e <- paste0("Desired proportion i = ",i_e)

symmetric_plot <- symmetric_graph + geom_point() + theme_bw() + labs(x = "percentage similars",y = "Ethnic Utility j") + ggtitle("Symmetric Single Peaked (S=1,M=0) ",subtitle = subt_cont_e) + theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25))
constant_plot <- constant_graph + geom_point() + theme_bw() + labs(x = "percentage similars",y = "Ethnic Utility j") + ggtitle("Linear + Constant (S=1,M=1)",subtitle = subt_cont_e) + theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25))
threshold_plot <- threshold_graph + geom_point() + theme_bw() + labs(x = "percentage similars",y = "Ethnic Utility j") + ggtitle("Schelling Threshold (S=0,M=1)",subtitle = subt_cont_e) + theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25))

suppressWarnings(
grid.arrange(symmetric_plot, constant_plot,threshold_plot)
)

```

In the ANNEX here you can see the function slope and values of ethnic utility given some parameteres. In the R-code you can set the parameters and test, e.g. comparing with NetLogo


# Value Utility {-}

The idea we discussed with Jan about value utility was to use the ethnic weight $ew$ of each agent and how distant it is from the average of ethnic weights of other agents in the potential neighborhood. To do so, I include the parameter $i_v \in [0,1]$, meaning the absolute desired distance between the agent's ethnic weight and the average of ethnic weights in its neighborhood. Values range from 0: only similars in the neighborhood are desired, to 1: any possible extrem distance is accepted. Here the ideal point becomes an interval, with average points outside of the ideal interval being equally distant. The function for ethnic utility as above with left increasing slope and right decreasing slope would not work. I elaborated another function using the same parameters S and M:\par
- $S[0,1]$, regulates the extreme of the slope closer to the ideal point 
- $M[0,1]$, regulates the extreme of the slope further the ideal point

Fig.\ref{fig:valuef} reports the 2 possible functions:\par
- S=1,M=0. Symmetric single peaked. Has a similar shape as ethnic utility, but due to different computation
- S=0, independent from the value of M: Schelling's Threshold function


$$
U^i_v=
\begin{cases}
1, & \text{if} \ \mid{\overline{ew}_j - ew_i}\mid \leq i_v, \\
\\
\left(\frac{(1 - \mid{\overline{ew}_j - ew_i}\mid) }{1 - i_v}\right) \times S_v, & otherwise
\end{cases}
$$

Where: \par
- $U^i_v$: Value utility of agent i
- $\overline{ew}_j$: average ethnic weight in neighborhood \textit{j}
- $ew_i$: ethnic weight of agent \textit{i}
- $i_v$: desired value distance of agent \textit{i}

```{r valuef, fig.width=6,fig.height=5, fig.align="center",fig.pos="H", include=TRUE, echo=FALSE, fig.cap="Comparison of the two function for the value utility of a neighborhood j"}

e_w <- 0.2
e_w_ng <- seq(0.0,1.0, by = 0.1)
i_v <- 0.1
S_v <- 1


fvf0p  <- f_val(e_w,0,i_v,S_v)
fvf1p  <- f_val(e_w,0.1,i_v,S_v)
fvf2p   <- f_val(e_w,0.2,i_v,S_v)
fvf3p   <- f_val(e_w,0.3,i_v,S_v)
fvf4p   <- f_val(e_w,0.4,i_v,S_v)
fvf5p   <- f_val(e_w,0.5,i_v,S_v)
fvf6p   <- f_val(e_w,0.6,i_v,S_v)
fvf7p   <- f_val(e_w,0.7,i_v,S_v)
fvf8p   <- f_val(e_w,0.8,i_v,S_v)
fvf9p  <- f_val(e_w,0.9,i_v,S_v)
fvf10p  <- f_val(e_w,1.0,i_v,S_v)

e_w <- 0.2
e_w_ng <- seq(0.0,1.0, by = 0.1)
i_v <- 0.1
S_v <- 0

fvf0t <- f_val(e_w,0,i_v,S_v)
fvf1t  <- f_val(e_w,0.1,i_v,S_v)
fvf2t   <- f_val(e_w,0.2,i_v,S_v)
fvf3t   <- f_val(e_w,0.3,i_v,S_v)
fvf4t   <- f_val(e_w,0.4,i_v,S_v)
fvf5t   <- f_val(e_w,0.5,i_v,S_v)
fvf6t  <- f_val(e_w,0.6,i_v,S_v)
fvf7t   <- f_val(e_w,0.7,i_v,S_v)
fvf8t   <- f_val(e_w,0.8,i_v,S_v)
fvf9t  <- f_val(e_w,0.9,i_v,S_v)
fvf10t  <- f_val(e_w,1.0,i_v,S_v)

x_graph_val <- seq(0.0,1.0, by = 0.1) #rep(seq(0.0,1.0, by = 0.1),2)
uti_val_pf <- c(fvf0p,fvf1p,fvf2p,fvf3p,fvf4p,fvf5p,fvf6p,fvf7p,fvf8p,fvf9p,fvf10p)
uti_val_th <- c(fvf0t,fvf1t,fvf2t,fvf3t,fvf4t,fvf5t,fvf6t,fvf7t,fvf8t,fvf9t,fvf10t)

symm_val <- data.frame(x_graph_val,uti_val_pf)
threshold_val <- data.frame(x_graph_val,uti_val_th)
  
symm_val_graph <- ggplot(symm_val,aes(x_graph_val,uti_val_pf))
thres_val_graph <- ggplot(threshold_val,aes(x_graph_val,uti_val_th))

subt_cont_v <- paste0("Ethnic weight i = ",e_w,"; ","Desired distance = ",i_v)

symm_val_plot <- symm_val_graph + geom_point() + theme_bw() + labs(x = "Mean ethnic weight neighborhood j",y = "Value utility j") + ggtitle(label = "Symmetric Single Peaked (S=1) ",subtitle = subt_cont_v) + theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))  + scale_x_continuous(breaks = seq(0.0,1.0,by = 0.1)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25))

thres_val_plot <- thres_val_graph + geom_point() + theme_bw() + labs(x = "Mean ethnic weight neighborhood j",y = "Value utility j") + ggtitle(label = "Threshold Schelling (S=0) ",subtitle = subt_cont_v) + theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))  + scale_x_continuous(breaks = seq(0.0,1.0,by = 0.1)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25))

suppressWarnings(
grid.arrange(symm_val_plot, thres_val_plot)
)


```

In the ANNEX here you can see the function slope and computation of value utility given some parameteres. In the R-code you can set the parameters and test.

*DOUBT/IDEA*: I have doubts with this definition of value utility (distance between agent and average ethnic weights of neighborhood), conceptually and for the computation. I will come back after implementing as above. 
As an extension of Schelling's model, I would focus on how similarity can be defined at the individual level between people as the distance between values/opinions, opposite to Schelling's condition of a "twofold, exhaustive and recognizable distinction" [@schelling1969, p. 488]. Defined the different types of similarity, the mechanism of threshold preferences and cascades would be the same, exploring how the value segregation and ethnic segregation interplay. This was the point of the ACS paper, I think it would better fit the ethnic boundary making's framework [@wimmer2013] and @esser2010's point along with the value homophily we mentioned in the ACS [@mcpherson2001], and my dissertation project. In this terms, in the ACS there were 2 levels of values (tolerants vs intolerants) and related preferences (value-oriented vs ethnicity-oriented), with the ideal distance of value-oriented tolerants equal to 0 (similars are only other tolerants). Here we expand this and extend the residential preferences. For the number of parameters and simplicity, the desired distance $i_v$ already must be included (it would only shift to distance between individual agents); to add there would be one continuous distribution of the values across the population (stylized parameter for norms, political orientations etc. in a population across the ethnic groups). The same functional form as for ethnic utility would then be used, making it more simple and any effect related to average computation/functional form avoided, focusing on the proportion as in Schelling. A simplest way is to use the distance between ethnic weights of agents as "values". I also have some doubts here both because they should be parameters of the choice and not definition of a person [@manski1977structure], plus literature and choices of the model. To not overwhelm and create confusion now I will come to it later when more clear.






# Probability to relocate to alternative {-}

Calculated the value utility and ethnic utility, the agent chooses between current location and the alternative location. The probability is calcualted using the logistic function. We decided to limit the number of options to 2, both for computational reasons and because there is not need to do otherwise. This is the condition for the logit model for binary discrete choice model with two options [@liao1994interpreting]. The dependent variable in such a model is the probability that an event will occur ($P=1$), or not ($P=0$). In a residential choice model and for two options as the agent-based model here, the agent must make a choice between moving to alternative location ($P=1$) or not ($P=0$), where the latter outcome implies to stay on the current location. Fitting the paradigm of maximization of utility, the probability to relocate to alternative increases if the utility derived from the alternative location is higher than the current one, as described above from @bruch2009preferences. Translated in the logistic function:

$P_j=\frac{1}{1 + \exp(-\lambda\times \Delta_{(U_j,U_i)})}$ 

An alternative to the logit model is the multinomial choice model, which is a generalization of the binary model where the choice is between more than two options [@train2009discrete]. The probability to choose one option over the others is calculated according to the conditional logit model [@mcfadden1973conditional], depending on the characteristics of the options. Applied to utility maximization and random utility models [@mcfadden1973conditional;@van2009]:

$P_j=\frac{\exp(U_j)}{\sum_{}exp((U_k))}$    

$P_j=\frac{1}{1 + \exp((-\beta_e{(e_j-e_i)}) + (-\beta_v{(v_j-v_i)})}$ 


$P_j=\frac{\exp(U_{(xj,yj)})}{\sum_{l}exp((U_{xl,yl}))}$    


$P_j=\frac{1}{1 + \exp((-\beta_xe_j - \beta_xe_i)}$ 

In Manski for probability to stay on current cell i$P_i=\frac{\exp(\beta_ee_j + \beta_vv_j)}{\exp(\beta_ee_j + \beta_vv_j) + \exp(\beta_ee_i + \beta_vv_i)}$

$P_i=\frac{1}{1 + \exp((\beta_ee_j + \beta_vv_j) - (\beta_ee_i + \beta_vv_i))}$



$P_j=\frac{1}{1 + \exp((-\beta_e(ej-ei)) + (-\beta_v(vj-vi)))}$

To my understanding, the two forms to calculate probability with logit model (logistic function) or multinomial choice (conditional logit), would be equivalent in representing a random utility model, as long as the number of options is limited to 2. This is the case of our model where the choice of the agent is between the current location and an alternative location. Both guarantee that the probability computed is between 0 and 1, that the maximization of utility drives the  agent to choose one option over the other. Both model a systematic component of utility and a  random component. Both assume that the random term $\epsilon$ is independent and equally distributed among options (i.i.d.). This link synthetizes: [logit_binary_choice, point C](https://en.wikipedia.org/wiki/Discrete_choice#A._Logit_with_attributes_of_the_person_but_no_attributes_of_the_alternatives)

The condition of random terms as independent and identically distributed

The random utility frame assumes an extreme-value distribution (Gumbel distribution) of the unknown random terms to fit this assumption. The difference of two Gumbel-distributed random variables has a logistic distribution, whose probability density function is the logistic function. The logistic function in the logit model implemented in this agent-based model calculates probability based on the difference of the two random utility

The implementation of the logit model here in the agent-based model fits this condition, since the probability to 


Since the logit model as formulated in the agent-based model uses the difference in the utility between the two options,


(need of the exponential function), in the conditional logit through the Gumbel distribution,  in the 




have in our model where th

should be equivalent in representing a random utility model and what we need. They both are probabilities ranging from 0 to 1, the characteristic of the option regulates the probability to be selected, i.e. the utility derived from the alternative neighborhood.

This link synthetizes: [logit_binary_choice, point C](https://en.wikipedia.org/wiki/Discrete_choice#A._Logit_with_attributes_of_the_person_but_no_attributes_of_the_alternatives)

Here is the logistic function implemented in the model for the choice between current location and alternative location:

$$
P_j=\frac{1}{1 + \exp((-ew\cdot k\times \Delta_{U_e})+(-vw\cdot k \times \Delta_{U_v}))}
$$

Where:\par
- $P_j$: Probability to relocate to alternative neighborhood \textit{j} leaving the current neighborhood
- $ew$:  Ethnic weight of agent \textit{i}
- $\Delta_{U_e}$: Ethnic Utility Difference (alternative - current)
- $vw$: Value weight \textit{i}
- $\Delta_{U_e}$: Value Utility Difference (alternative - current)
- $k$: constant

$P_j$ thus ranges from 0 = the agent remains in its current location, to 1 = the agent moves to the alternative location.



which uses the conditioanl logit to calculate the probability to choose $\textit{j}$ ($P_j=\frac{\exp(U_{(xjyj)})}{\sum_{l}exp((U_{xl,yl}))}$). As I wrote and as I understand so far, for two options the calculation of probability according to the multinomial choice formulation and the logistic function for binary choice can be considered equivalent as they both will assure the $i.i.d$ distribution of the random term, which is the priority of random utility models.\\



$k$ times ethnic weight $ew$ and $k$ times $vw$ substitute the parameters in random  utility for how important the ethnic composition and value composition are in the logistic function ($\lambda$ in $P_j=\frac{1}{1 + \exp(-\lambda\times \Delta_{U_e})+(-\lambda \times \Delta_{U_v}))}$ and $\beta_xe_j$ $\beta_yv_j$ in  $\textit{j}$ ($P_j=\frac{\exp(U_{(xjyj)})}{\sum_{l}exp((U_{xl,yl}))}$. My idea is that ethnic weight and value weight range from 0 to 1, whose value is too low causing random choices, by multiplying by a constant the ratio in the distribution point stay the same.\par
Below I report some graphs where I implement the logistic function as above tuning $k \cdot ew$ and $k \cdot vw$, checking if it would reproduce what expected from random utility models, I think it does. For parameters equal to 0, the probability to choose the alternative is $50%$ in all conditions. The best option is taken when parameters are increased, always $50%$ when the actual difference is 0. I tested some conditions considering the 2 types of utility (some would be not possible in the simulation if we keep $vw=1-ew$, but here was to see how it worked).\par
On the x-axis is ethnic utility difference, on the y-axis the value utility difference. Each ranges from -1 (alternative = 0, current = 1), to 1 (alternative = 1, current = 0), with 0 = no difference between the options. I made up them out of possible conditions. For each condition (21x21= 441), the probability function is calculated using the logisticdunction above. Heatmaps in fig. \ref{fig:heatmaps}

In the ANNEX of pdf is the sigmoid function for the logistic function, too long. Each vignette is one level of ethnic utility difference, the x-axis is the whole value utility difference range. You can manipulate $ew$, $vw$ and $k$ in the R code.

```{r heatmaps,  fig.width=12,fig.height=12,fig.cap="Probability to choose alternative location",fig.align="center", include=TRUE, echo=FALSE}

k_v <- 10

df_0 <- mutate(dfprob,e_w=0,v_w=0,k=k_v, proba = prob(d_u_e, d_u_v,e_w,v_w,k))
df_05 <- mutate(dfprob,e_w=0.5,v_w=0.5,k=k_v, proba = prob(d_u_e, d_u_v,e_w,v_w,k))
df_maxe <- mutate(dfprob,e_w=1,v_w=0,k=k_v, proba = prob(d_u_e, d_u_v,e_w,v_w,k))
df_maxv <- mutate(dfprob,e_w=0,v_w=1,k=k_v, proba = prob(d_u_e, d_u_v,e_w,v_w,k))
df_r <- mutate(dfprob,e_w=0.1,v_w=0.1,k=k_v, proba = prob(d_u_e, d_u_v,e_w,v_w,k))
df_1 <- mutate(dfprob,e_w=10,v_w=10,k=k_v, proba = prob(d_u_e, d_u_v,e_w,v_w,k))

prob_comb <- function(a){
title_cond_fin <- paste0("Ethnic weight = ",a$e_w*a$k,"; ","Value weight = ",a$v_w*a$k)
fina_rast <- ggplot(a,aes(d_u_e,d_u_v))

 plot_fina_rast <-  suppressWarnings(suppressMessages(
    fina_rast + geom_raster(aes(fill = proba)) + theme_bw() + labs(x = "Diff. ethnic (alternative - current)",y = "Diff. value (alternative - current)") + labs(title = title_cond_fin, caption = "-1: Min Utility Alternative; 1: Max Utility Alternative") + theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust=0.5),plot.caption = element_text(hjust=0.5)) 
    + geom_vline(xintercept = 0, colour = "red", linetype = "dotted") + geom_hline(yintercept = 0, colour = "red", linetype = "dotted") + scale_fill_continuous(name = "Probability",limits=c(0,1), breaks=seq(0,1,0.25))
  ))
}

plot_0 <- prob_comb(df_0)
plot_05 <- prob_comb(df_05)
plot_maxe <- prob_comb(df_maxe)
plot_maxv <- prob_comb(df_maxv)
plot_r <- prob_comb(df_r)
plot_1 <- prob_comb(df_1)

grid.arrange( plot_0,plot_05,plot_maxe,plot_maxv,plot_r,  plot_1,nrow=3,ncol=2)

```

```{r prob3D,  fig.width=18,fig.height=18,fig.cap="Probability to choose alternative location 3D",fig.align="center", include=TRUE, echo=FALSE}

 

tridi_0_0 <- ggdraw() + draw_image("3d_0_0.png")
tridi_5_5 <- ggdraw() + draw_image("3d_5_5.png")
tridi_10_0 <- ggdraw() + draw_image("3d_10_0.png")
tridi_0_10 <- ggdraw() + draw_image("3d_0_10.png")
tridi_100_100 <- ggdraw() + draw_image("3d_100_100.png")
tridi_1_1 <- ggdraw() + draw_image("3d_1_1.png")

grid.arrange(tridi_0_0,tridi_5_5,tridi_10_0,tridi_0_10,tridi_1_1,tridi_100_100,ncol=2,nrow=3)


```

```{r interact3D, include=TRUE,echo= FALSE}

# To explore the 3D graph, select all lines and run (alt + Enter), or change in line above r interact3D, include = TRUE

prob_3d(df_0)
prob_3d(df_05)
prob_3d(df_maxe)
prob_3d(df_maxv)
prob_3d(df_1)
prob_3d(df_r)

#Plotly seems more adapted for html, but works here
```

# ANNEX {-}

## Ethnic Utility Calculation

```{r ethnic utility individual-run,fig.width=4,fig.height= 3, fig.align="center", include=TRUE, echo=FALSE}
# ETHNIC UTILITY:
# Choose parameters for desired ethnic similar proportion (i_e, float number), left-slope utility curve (S),right-slope utility curve (M),total number of agents in the neighborhood (n), then run (green arrow top-right).
# The calculations are done for a max=8 neighbors (assuming we keep 8-patches Moore neighbor in NetLogo). Utility can be calculated with n > 8, but table row and x-axis graph will stop at 8.

i_e = 0.6   # parameters to manipulate
S = 1     # Symmetric single-peaked function: S=1,M=0
M = 0     # Linear + Constant function = S=1,M=1
n = 8     # Schelling Threshold function = S=0,M=1

f0m <- f_eth(i_e,M,0,n,S) # ethnic utility for each option, the increasing number is the number of agents of same ethnicity
f1m <- f_eth(i_e,M,1,n,S)
f2m <- f_eth(i_e,M,2,n,S)
f3m <- f_eth(i_e,M,3,n,S)
f4m <- f_eth(i_e,M,4,n,S)
f5m <- f_eth(i_e,M,5,n,S)
f6m <- f_eth(i_e,M,6,n,S)
f7m <- f_eth(i_e,M,7,n,S)
f8m <- f_eth(i_e,M,8,n,S)


Utility_E <- c(f0m,f1m,f2m,f3m,f4m,f5m,f6m,f7m,f8m)    # used to make up table and graph

M. <- rep(M,9)
S. <- rep(S,9)
prop_des <- rep(i_e,9)
num_tot <- rep(n,9)
num_sim <- seq(0, 8, by = 1)

report_E <- na.omit(data.frame(M.,S.,prop_des,num_tot,num_sim,Utility_E))

title_cond <- paste0("Desired proportion = ", i_e,"; ", "S = ", S,"; " ,"M = ", M)

plot_report_E <- ggplot(report_E,aes(num_sim,Utility_E))

suppressWarnings(suppressMessages(
plot_report_E + geom_point() + theme_bw() + labs(x = "Number similar agents in j",y = "Ethnic Utility j") + ggtitle(label = title_cond) + theme(plot.title = element_text(hjust = 0.5)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25)) + scale_x_continuous(limits =  c(0,n), breaks = seq(0,n,by = 1))
))

suppressWarnings(suppressMessages(
knitr::kable(report_E,align="c")
))



```

## Value Utility Calculation {-}

```{r value individual run,fig.width=5, fig.height= 3, fig.align="center", include=TRUE, echo=FALSE }
# VALUE UTILITY:
# Choose parameters for ethnic weight of agent i (e_w), desired value distance (i_v), left-slope utility curve (S),right-slope utility curve (M).
# Calculations are done for each ethnic weight mean of the neighborhood, from 0 to 1. The extreme case is desired value distance 1, meaning all mean ethnic weight of the neighborhood are included. Values of i_v > 1 would not affect results, but nonsense 


e_w <- 0.5    # parameters to manipulate
i_v <- 0.2    # Symmetric = S:1,M:0/Threshold = S:0
S_v  <- 0
M <-  0

fv0d2 <- f_val(e_w,0,M,i_v,S_v)             # value utility for each option, 
fv1d2 <- f_val(e_w,0.1,M,i_v,S_v)           # increasing nuMber is average ethnic weight of neighborhood j
fv2d2 <- f_val(e_w,0.2,M,i_v,S_v)
fv3d2 <- f_val(e_w,0.3,M,i_v,S_v)
fv4d2 <- f_val(e_w,0.4,M,i_v,S_v)
fv5d2 <- f_val(e_w,0.5,M,i_v,S_v)
fv6d2 <- f_val(e_w,0.6,M,i_v,S_v)
fv7d2 <- f_val(e_w,0.7,M,i_v,S_v)
fv8d2 <- f_val(e_w,0.8,M,i_v,S_v)
fv9d2 <- f_val(e_w,0.9,M,i_v,S_v)
fv10d2 <- f_val(e_w,1.0,M,i_v,S_v)


Utility_V <- c(fv0d2,fv1d2,fv2d2,fv3d2,fv4d2,fv5d2,fv6d2,fv7d2,fv8d2,fv9d2,fv10d2)  # used to make up table and graph

mean_ew_ng <- seq(0.0, 1.0, by = 0.1)
ew_agent <- rep(e_w,11)
# Mv <- rep(M,11)
# Sv <- rep(S,11)
des_dist <- rep(i_v,11)

report_V <- na.omit(data.frame(M,S_v,des_dist,ew_agent,mean_ew_ng,Utility_V))

title_cond_V <- paste0("Ethnic weight i = ", e_w,"; desired distance i = ",i_v,"\n\r","M =", M,"; ", "S = ",S_v)

plot_report_V <- ggplot(report_V,aes(mean_ew_ng,Utility_V))

suppressWarnings(suppressMessages(
plot_report_V + geom_point() + theme_bw() + labs(x = "Mean ethnic weight j",y = "Value Utility j") + ggtitle(label = title_cond_V) + theme(plot.title = element_text(hjust = 0.5)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25)) + scale_x_continuous(limits =  c(0,1), breaks = seq(0,1,by = 0.1))
))

suppressWarnings(suppressMessages(
knitr::kable(report_V,align = "c")
))

```

## Logistic Function calculation {-}

```{r logistic, fig.width=5,fig.height=3,fig.align='left',include=TRUE, echo=FALSE}

# PROBABILITY to relocate to alternative
# Choose the parameters for ethnic weight (e_w), value weight (v_w) and the cstant k. As default v_w is complementar to e_w (1-e_w, as will be in the abm), you can change this.
# The parameter for importance of relative utility is equal to e_w*k for ethnic utility and v_w*k for value utility. The highest the parameter for that dimension, the less random is the choice and the more depending on the option with highest relative utility
# Each vignette is one level of ethnic utility difference (-1 to 1), the x-axis the value-difference (-1 to 1), on y-axis the probability to relocate.


e_w <- 0.5              
v_w <- 1 - e_w
k <- 10                                   

for (d_u_e in seq (-1.0,1.0, by = 0.1)){    # Runs the same function for each level of ethnic utility difference
                                            # d_u_e, the increasing number is the value utility difference
dis_1neg   <- prob(d_u_e,-1.0,e_w,v_w,k)
dis_0.9neg <- prob(d_u_e,-0.9,e_w,v_w,k)
dis_0.8neg <- prob(d_u_e,-0.8,e_w,v_w,k)
dis_0.7neg <- prob(d_u_e,-0.7,e_w,v_w,k)
dis_0.6neg <- prob(d_u_e,-0.6,e_w,v_w,k)
dis_0.5neg <- prob(d_u_e,-0.5,e_w,v_w,k)
dis_0.4neg <- prob(d_u_e,-0.4,e_w,v_w,k)
dis_0.3neg <- prob(d_u_e,-0.3,e_w,v_w,k)
dis_0.2neg <- prob(d_u_e,-0.2,e_w,v_w,k)
dis_0.1neg <- prob(d_u_e,-0.1,e_w,v_w,k)
dis_0   <- prob(d_u_e,0.0,e_w,v_w,k)
dis_0.1 <- prob(d_u_e,0.1,e_w,v_w,k)
dis_0.2 <- prob(d_u_e,0.2,e_w,v_w,k)
dis_0.3 <- prob(d_u_e,0.3,e_w,v_w,k)
dis_0.4 <- prob(d_u_e,0.4,e_w,v_w,k)
dis_0.5 <- prob(d_u_e,0.5,e_w,v_w,k)
dis_0.6 <- prob(d_u_e,0.6,e_w,v_w,k)
dis_0.7 <- prob(d_u_e,0.7,e_w,v_w,k)
dis_0.8 <- prob(d_u_e,0.8,e_w,v_w,k)
dis_0.9 <- prob(d_u_e,0.9,e_w,v_w,k)
dis_1   <- prob(d_u_e,1.0,e_w,v_w,k)

  
value_difference <- seq(-1.0,1.0, by = 0.1)       # here to setup the plot and change info for each vignette
  
prob_choice <- c(dis_1neg,dis_0.9neg,dis_0.8neg,dis_0.7neg,dis_0.6neg,dis_0.5neg,dis_0.4neg,dis_0.3neg,dis_0.2neg,dis_0.1neg,dis_0,dis_0.1,dis_0.2,dis_0.3,dis_0.4,dis_0.5,dis_0.6,dis_0.7,dis_0.8,dis_0.9,dis_1)
 
 
title_cond_prob <- paste0("Diff. Ethnic Utility (alternative - current): ",d_u_e)
title_caption <-  paste0("Ethnic weight = ",e_w*10," ; ","Value weight = ",v_w*10,"\n\r","-1: Min Utility Alternative; 1: Max Utility Alternative")
   
report_prob <- na.omit(data.frame(value_difference,prob_choice))
  
plot_report_prob <- ggplot(report_prob,aes(value_difference,prob_choice))
  
final_prob <-  suppressWarnings(suppressMessages(plot_report_prob + geom_point() + theme_bw() + labs(x = "Diff. Value Utility (alternative - current)",y = "Probability") + labs(title=title_cond_prob, caption = title_caption) + theme(plot.title = element_text(hjust = 0.5),plot.caption = element_text(hjust=0.5)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25)) + scale_x_continuous(limits =  c(-1,1), breaks = seq(-1,1,by = 0.2)) + geom_vline(xintercept = 0, colour = "red", linetype = "dotted") + geom_hline(yintercept = 0.5, colour = "red", linetype = "dotted")))
  
plot(final_prob)

}

```
<!-- 
Notes on the value utility
While in Schelling the integration/segregation continuum is on the twofold dimension of ethnicity, here would be on the likelihood to have someone with opinions too far from the own in the neighborhood or not, as in the geographical polarization literature. If I am not wrong, I also think that if the average of neighorhood is used, then one agent highly distant would influence the choice, which I think might be not realistic. Even though there might be solutions for this, my doubt is on the corresponding assumption and theory behind. Connecting to the ACS paper, in the ACS paper there would be 2 levels of values (intolerant vs tolerant) with different homophily behavior (ethnicity-oriented vs value-oriented), and for the value homophily the ideal distance 0 (tolerant only accepts other tolerant). As for parameters to include, the ideal distance is as already envisaged here (it will be between agents and not agent-average of neighborhood). Additionally, a distribution of values among agents [0,1] shoud be included, or the same ethnic weights as first try to keep simple. -->


# References
