---
output:
  bookdown::pdf_document2:
    toc: false
 #   keep_tex: false
    fig_caption: yes
title: "Paper notes"
author: Rocco Paolillo
bibliography: "references.bib"
always_allow_html: yes
# target: BIGSSS Research Day by September 15th, presented  on October 25th. 6000 words: around 12 pages.
# csl: apa.csl # by default: Chicago style
header-includes:
- \usepackage{float}
- \usepackage{multirow}
- \usepackage{xcolor} 
- \usepackage{amsmath}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.lp="fig:",warning = FALSE)

# install.packages("tinytex", repos = "https://cloud.r-project.org" )



library(knitr)
library(Hmisc)
library(ggplot2)
library(gridExtra)
library(ggpubr)
library(dplyr)
library(grid)
library(ggrepel)
library(magicfor)
library(dplyr)
library(plot3D)
library(rgl)
library(plotly)
library(tidyr)
library(plyr)
library(rgl)
library(graphics)
library(cowplot)
library(magick) 
library(xtable)


# Calculation ethnic utility

  f_eth <- function(i_e,M,x,n,S){
   if (x > n){
     U <- NA}else{
     if (x < round(n*i_e,digits = 2)){
   U <- (x / round((n*i_e),digits = 2)) * S
      }else if (x > round((n*i_e),digits = 2)){
         U <- M + ((1- (x/n))*(1-M))/(1-i_e) 
        }else{
     U <- 1}
        round(U,digits = 3)
      }
 }


# Calculation value utility

f_val <- function(e_w,ew_ng,M,i_v,S){
  if (round(abs(e_w-ew_ng), digits=2) <= i_v) {
    U <- 1
    }else{
      U <- (M + ((1-(round(abs(e_w-ew_ng), digits=2)))*(1-M))/(1-i_v)) * S
      }
  round(U,digits = 3)
  }
 
# ethnic utility difference and value utility difference

magic_for(print,silent = TRUE)

for (i in seq (-1.0,1.0, by = 0.1)){
  eth_diff <- rep(i,21)
  print(eth_diff)
}

d_u_e <-  magic_result_as_vector()
d_u_v <- rep(seq(-1,1,by = 0.1),21)

dfprob <- data.frame(d_u_e,d_u_v,e_w=0,v_w=0,k=0)

dfprob
# Probability to move to alternative (random utility with logistic regression) 

prob <- function(d_u_e,d_u_v,e_w,v_w,k){round(1 / (1 + exp((-(e_w*k)*(d_u_e)) + (-(v_w*k)*(d_u_v)))),digits= 2)}


prob_3d <- function(b){
  fx <- d_u_e
  fy <- d_u_v
  fz <- b$prob
  
  tit <- paste0("Ethnic weight = ",b$e_w*b$k,"; ","Value weight = ",b$v_w*b$k, "\n\r -1:MIN Alternative, 1:MAX Alternative")
 
   tridi_prob <- plot_ly(x=fx,y=fy,z=fz, type="scatter3d", color=fz, mode="markers")  %>% 
    layout(scene = list(
       xaxis = list(title = "x = Diff. Ethnic Ut."),
       yaxis = list(title = "y = Diff. Value Ut."),
       zaxis = list(title = "z = Probability")
     ), 
     annotations = (list(x = 0.5, y = 1, text = tit, showarrow = F, font=list(size=18)
     ))
   ) %>% hide_colorbar() 

 tridi_prob 

 }


# install.packages("tinytex", repos = "https://cloud.r-project.org" ), try if debug needed

```


The basic idea is to introduce a beta distribution for $\beta$ in the utility definition of neighborhood $j$ for agent $i$ :

$$
U^i_{(ej,yj)}   = \beta_xe_j + \beta_yv_j + \epsilon_j
$$

With $\beta_x$ the importance of ethnic composition $x_j$ of neighborhood $j$ and $\beta_y$ its value composition $y_i$.

To avoid confusion between parameter beta and beta distribution used in the simulation, $\beta_x$ is called ethnic weight (ew in R code), $\beta_y$ is called value weight (v_w in R code).

We want to compare different type of functions, in particular to compare the single-peaked function as modeled by [@zhang2011, graphic p. 174] with the Schelling's original threshold we also  used in the ACS paper, and a mixed one where utility increases until the ideal point as in Zhang, and remains constant at max. 1 when the ethnic composition exceeds the ideal point. The last function comes from the idea that it can be a realistic scenario in people's relocation choice. 

To have all of the functions coming from the same computation and reduce as much, I modified @zhang2011's formula, assuming max Utility = 1 and introducing 2 parameters to the formula, as in the simulation:\par
- $S[0,1]$, regulating the increasing left slope
- $M[0,1]$, regulating the decreasing right slope (as in Zhang)

# Ethnic Utility {-}

$$
U^i_e=
\begin{cases}
1, & \text{if} x =  n\times i_e, \\
\\
(\frac{x}{n \times i_e})\times S, & \text{if} \ x < n\times i_e, \\
\\
M + \frac{(1 - \frac{x}{n}) \times (1 - M)}{1 - i_e}, & \text{if} \ x > n\times i_e 
\end{cases}
$$

Where: \par
- $U^i_e$: Ethnic utility of agent i
- $x$: number of similar agents in the neighborhood
- $n$: total number of agents in the neighborhood
- $i_e$: desired ethnic composition

Below example of the three functions, reporting how $S$ and $M$ are set to calculate them. The example refer to desired compostion $50\%$ ($i_e = 0.5$). It was calculated out of a 8 agents neighborhood (with 4 agents of same ethnicity representing the $50 \%$)


```{r ethnic graph function, fig.width=6,fig.height= 8, fig.align="center",  include=TRUE, echo=FALSE}

i_e = 0.5
M = 0
S = 1
n = 8

f0s <- f_eth(i_e,M,0,n,S)
f1s <- f_eth(i_e,M,1,n,S)
f2s <- f_eth(i_e,M,2,n,S)
f3s <- f_eth(i_e,M,3,n,S)
f4s <- f_eth(i_e,M,4,n,S)
f5s <- f_eth(i_e,M,5,n,S)
f6s <- f_eth(i_e,M,6,n,S)
f7s <- f_eth(i_e,M,7,n,S)
f8s <- f_eth(i_e,M,8,n,S)

i_e = 0.5
M = 1
S = 1
n = 8

f0c <- f_eth(i_e,M,0,n,S)
f1c <- f_eth(i_e,M,1,n,S)
f2c <- f_eth(i_e,M,2,n,S)
f3c <- f_eth(i_e,M,3,n,S)
f4c <- f_eth(i_e,M,4,n,S)
f5c <- f_eth(i_e,M,5,n,S)
f6c <- f_eth(i_e,M,6,n,S)
f7c <- f_eth(i_e,M,7,n,S)
f8c <- f_eth(i_e,M,8,n,S)


i_e = 0.5
M = 1
S = 0
n = 8

f0t <- f_eth(i_e,M,0,n,S)
f1t <- f_eth(i_e,M,1,n,S)
f2t <- f_eth(i_e,M,2,n,S)
f3t <- f_eth(i_e,M,3,n,S)
f4t <- f_eth(i_e,M,4,n,S)
f5t <- f_eth(i_e,M,5,n,S)
f6t <- f_eth(i_e,M,6,n,S)
f7t <- f_eth(i_e,M,7,n,S)
f8t <- f_eth(i_e,M,8,n,S)

Utility_S <- c(f0s,f1s,f2s,f3s,f4s,f5s,f6s,f7s,f8s)
Utility_C <- c(f0c,f1c,f2c,f3c,f4c,f5c,f6c,f7c,f8c)
Utility_T <- c(f0t,f1t,f2t,f3t,f4t,f5t,f6t,f7t,f8t)

x_graph <- rep(seq(0, 100, by = 12.5),3)
funct_symm <- c(rep("symmetric",9),rep("constant",9),rep("threshold",9))
utility_location <- c(Utility_S,Utility_C,Utility_T)

symmetric <- data.frame(x_graph[c(0:9)],utility_location[c(0:9)],funct_symm[c(0:9)])
constant <- data.frame(x_graph[c(10:18)],utility_location[c(10:18)],funct_symm[c(10:18)])
threshold <- data.frame(x_graph[c(19:27)],utility_location[c(19:27)],funct_symm[c(19:27)])

symmetric_graph <- ggplot(symmetric,aes(x_graph[c(0:9)],utility_location[c(0:9)])) 
constant_graph <- ggplot(constant,aes(x_graph[c(10:18)],utility_location[c(10:18)])) 
threshold_graph <- ggplot(threshold,aes(x_graph[c(19:27)],utility_location[c(19:27)])) 

subt_cont_e <- paste0("Desired proportion i = ",i_e)

symmetric_plot <- symmetric_graph + geom_point() + theme_bw() + labs(x = "percentage similars",y = "Ethnic Utility j") + ggtitle("Symmetric Single Peaked (S=1,M=0) ",subtitle = subt_cont_e) + theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25))
constant_plot <- constant_graph + geom_point() + theme_bw() + labs(x = "percentage similars",y = "Ethnic Utility j") + ggtitle("Linear + Constant (S=1,M=1)",subtitle = subt_cont_e) + theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25))
threshold_plot <- threshold_graph + geom_point() + theme_bw() + labs(x = "percentage similars",y = "Ethnic Utility j") + ggtitle("Schelling Threshold (S=0,M=1)",subtitle = subt_cont_e) + theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25))

suppressWarnings(
grid.arrange(symmetric_plot, constant_plot,threshold_plot, bottom = "Comparison of the three functions for ethnic utility of a neighborhood j")
)

```

# Value Utility {-}

$$
U^i_v=
\begin{cases}
1, & \text{if} \ e_w \leq i_v, \\
\\
\left(M + \frac{(1 - \mid{\overline{ew}_j - ew_i}\mid) \times (1 - M)}{1 - i_v}\right) \times S, & otherwise
\end{cases}
$$

Where: \par
- $U^i_v$: Ethnic utility of agent i
- $\overline{ew}_j$: average ethnic weight in neighborhood \textit{j}
- $ew_i$: ethnic weight of agent \textit{i}
- $i_e$: desired ethnic composition

*DOUBT*: for the value composition, have a distribution of opinions/beliefs for agents within ethnic groups, the value weight would be still  1 - e_w, and a parameter of how similar others are considered based on how they distantiate from the own opinion. This would be a comparison to Schelling's definition of similarity based on twofold, exhaustive and exclusive category (i.e. ethnicity), but rather on an cross-categorical, individual and constructed definition of similarity/desirability, and how important it is.

```{r value graph function, fig.width=6,fig.height=5, fig.align="center", include=TRUE, echo=FALSE}

e_w <- 0.2
e_w_ng <- seq(0.0,1.0, by = 0.1)
i_v <- 0.1
S <- 1
M <- 0

fvf0p  <- f_val(e_w,0,M,i_v,S)
fvf1p  <- f_val(e_w,0.1,M,i_v,S)
fvf2p   <- f_val(e_w,0.2,M,i_v,S)
fvf3p   <- f_val(e_w,0.3,M,i_v,S)
fvf4p   <- f_val(e_w,0.4,M,i_v,S)
fvf5p   <- f_val(e_w,0.5,M,i_v,S)
fvf6p   <- f_val(e_w,0.6,M,i_v,S)
fvf7p   <- f_val(e_w,0.7,M,i_v,S)
fvf8p   <- f_val(e_w,0.8,M,i_v,S)
fvf9p  <- f_val(e_w,0.9,M,i_v,S)
fvf10p  <- f_val(e_w,1.0,M,i_v,S)

e_w <- 0.2
e_w_ng <- seq(0.0,1.0, by = 0.1)
i_v <- 0.1
S <- 0
M <- 0 

fvf0t <- f_val(e_w,0,M,i_v,S)
fvf1t  <- f_val(e_w,0.1,M,i_v,S)
fvf2t   <- f_val(e_w,0.2,M,i_v,S)
fvf3t   <- f_val(e_w,0.3,M,i_v,S)
fvf4t   <- f_val(e_w,0.4,M,i_v,S)
fvf5t   <- f_val(e_w,0.5,M,i_v,S)
fvf6t  <- f_val(e_w,0.6,M,i_v,S)
fvf7t   <- f_val(e_w,0.7,M,i_v,S)
fvf8t   <- f_val(e_w,0.8,M,i_v,S)
fvf9t  <- f_val(e_w,0.9,M,i_v,S)
fvf10t  <- f_val(e_w,1.0,M,i_v,S)

x_graph_val <- seq(0.0,1.0, by = 0.1) #rep(seq(0.0,1.0, by = 0.1),2)
uti_val_pf <- c(fvf0p,fvf1p,fvf2p,fvf3p,fvf4p,fvf5p,fvf6p,fvf7p,fvf8p,fvf9p,fvf10p)
uti_val_th <- c(fvf0t,fvf1t,fvf2t,fvf3t,fvf4t,fvf5t,fvf6t,fvf7t,fvf8t,fvf9t,fvf10t)

symm_val <- data.frame(x_graph_val,uti_val_pf)
threshold_val <- data.frame(x_graph_val,uti_val_th)
  
symm_val_graph <- ggplot(symm_val,aes(x_graph_val,uti_val_pf))
thres_val_graph <- ggplot(threshold_val,aes(x_graph_val,uti_val_th))

subt_cont_v <- paste0("Ethnic weight i = ",e_w,"; ","Desired distance = ",i_v)

symm_val_plot <- symm_val_graph + geom_point() + theme_bw() + labs(x = "Mean ethnic weight neighborhood j",y = "Value utility j") + ggtitle(label = "Symmetric Single Peaked (S=1,M=0) ",subtitle = subt_cont_v) + theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))  + scale_x_continuous(breaks = seq(0.0,1.0,by = 0.1)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25))

thres_val_plot <- thres_val_graph + geom_point() + theme_bw() + labs(x = "Mean ethnic weight neighborhood j",y = "Value utility j") + ggtitle(label = "Threshold Schelling (S=0,M=0) ",subtitle = subt_cont_v) + theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))  + scale_x_continuous(breaks = seq(0.0,1.0,by = 0.1)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25))

suppressWarnings(
grid.arrange(symm_val_plot, thres_val_plot, bottom = "Comparison of the two functions for value utility of a neighborhood j.")
)


```

$$
P_j=\frac{1}{1 + \exp((-ew\cdot k\times \Delta_{U_e})+(-vw\cdot k \times \Delta_{U_v}))}
$$

Where:\par
- $P_j$: Probability to relocate to alternative neighborhood \textit{j} leaving the current neighborhood
- $ew$:  Ethnic weight of agent \textit{i}
- $\Delta_{U_e}$: Ethnic Utility Difference (alternative - current)
- $vw$: Value weight \textit{i}
- $\Delta_{U_e}$: Value Utility Difference (alternative - current)
- $k$: constant

The idea of $k$ constant is to include the parameter of determinism in the random utility formula, i.e. from 0: the probabiity to choose the alternative is totally random due to random term $\epsilon$, to infinity, the best option is taken with probability equal to 1. To reduce the number of parameters, and being constitent with the conceptual model, I derive the parameter for ethnic utility from the ethnic weight $ew$ and the parameter for value utility from the value weight $vw$ in the agent-based  model. Remember that $ew$ ranges $[0,1]$ according to beta distribution, and $vw$ is calculated as $1-ew$. The parameter is calculated as $k\cdot ew$ and $k \cdot vw$, meaning that with $k=10$, the parameter for ethnic utility will range from 0 to 10, $k=100$, range from 0 to 100, $k = 0$: all agents will have parameter equal 0. It will be one slider in the agent-based model.\par
The aim of the logistic function above is to implement the random  utility for a binary choice for the agent between the current location $x$ and alternative location $j$, with $P_{xj}=0$ meaning the agent stays on the current location, $P_{xj}=1$ the agent moves to the alternative location $j$.\par
Below I report some graphs on $P_{xj}$ where the logistic funtion above is implemented for each combination of ethnic utility difference $\Delta_{U_e}$ and value utility difference $\Delta_{U_v}$. These are the possible values expected from the agent-based model: assuming that both the ethnic and value utility for each location ranges from 0 to 1, the difference (alternative - current) ranges from -1 (alternative = 0, current = 1), to 1 (alternative =1, current = 0), with 0 meaning equal utility sizes. This creates 11 levels  for each utility, $\times$ 2 number of utility = 441 conditions. The aim of the graphs was to relate the probability as function of 2 dimensions, so I use the heatmaps in fig.\ref{fig:heatmaps}. They have the same content of the 3D plots in fig.\ref{fig:prob3D} which I think serve better the scope: in the R code you can interact with the graph and see actual probability for each point, but need to do it from the RStudio interface (chunk "interact3d").\par
Each graph reports the parameter ethnic weight $ew \cdot k$ and parameter value weight $vw \cdot k$. In all conditions $k = 10$, which I saw shows most realistic scenarios, i.e. lower probability for lower ethnic/utility difference. To check if the random utility for binary choice is correctly implemented, $P_{xj}=0.50$ with $ew \cdot k = 0$ and $vw \cdot k = 0$, meaning the choice between current and alternative location is totally random. In the last condition $ew \cdot k = 100$ and $vw \cdot k = 100$, $P_{xj}=0$ for all conditions where current location is higher in both types of utility (below the diagonal), shifts to $P_{xj}=1$ for all conditions with both utilities higher in the alternative location (above the diagonal), and $P_{xj}=0.5$ on the diagonal where the alternatives have same utility with difference equal 0. So the choice is totally dependent on the characteristic of the neighborhood, with the best option being taken. I think it can confirm the random utility framework for two options. 

```{r heatmaps,  fig.width=12,fig.height=12,fig.cap="Probability to choose alternative location",fig.align="center", include=TRUE, echo=FALSE}

k_v <- 10

df_0 <- mutate(dfprob,e_w=0,v_w=0,k=k_v, proba = prob(d_u_e, d_u_v,e_w,v_w,k))
df_05 <- mutate(dfprob,e_w=0.5,v_w=0.5,k=k_v, proba = prob(d_u_e, d_u_v,e_w,v_w,k))
df_maxe <- mutate(dfprob,e_w=1,v_w=0,k=k_v, proba = prob(d_u_e, d_u_v,e_w,v_w,k))
df_maxv <- mutate(dfprob,e_w=0,v_w=1,k=k_v, proba = prob(d_u_e, d_u_v,e_w,v_w,k))
df_r <- mutate(dfprob,e_w=0.1,v_w=0.1,k=k_v, proba = prob(d_u_e, d_u_v,e_w,v_w,k))
df_1 <- mutate(dfprob,e_w=10,v_w=10,k=k_v, proba = prob(d_u_e, d_u_v,e_w,v_w,k))

prob_comb <- function(a){
title_cond_fin <- paste0("Ethnic weight = ",a$e_w*a$k,"; ","Value weight = ",a$v_w*a$k)
fina_rast <- ggplot(a,aes(d_u_e,d_u_v))

 plot_fina_rast <-  suppressWarnings(suppressMessages(
    fina_rast + geom_raster(aes(fill = proba)) + theme_bw() + labs(x = "Diff. ethnic (alternative - current)",y = "Diff. value (alternative - current)") + labs(title = title_cond_fin, caption = "-1: Min Utility Alternative; 1: Max Utility Alternative") + theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust=0.5),plot.caption = element_text(hjust=0.5)) 
    + geom_vline(xintercept = 0, colour = "red", linetype = "dotted") + geom_hline(yintercept = 0, colour = "red", linetype = "dotted") + scale_fill_continuous(name = "Probability",limits=c(0,1), breaks=seq(0,1,0.25))
  ))
}

plot_0 <- prob_comb(df_0)
plot_05 <- prob_comb(df_05)
plot_maxe <- prob_comb(df_maxe)
plot_maxv <- prob_comb(df_maxv)
plot_r <- prob_comb(df_r)
plot_1 <- prob_comb(df_1)

grid.arrange( plot_0,plot_05,plot_maxe,plot_maxv,plot_r,  plot_1,nrow=3,ncol=2)

```

```{r prob3D,  fig.width=18,fig.height=18,fig.cap="Probability to choose alternative location 3D",fig.align="center", include=TRUE, echo=FALSE}

 

tridi_0_0 <- ggdraw() + draw_image("3d_0_0.png")
tridi_5_5 <- ggdraw() + draw_image("3d_5_5.png")
tridi_10_0 <- ggdraw() + draw_image("3d_10_0.png")
tridi_0_10 <- ggdraw() + draw_image("3d_0_10.png")
tridi_100_100 <- ggdraw() + draw_image("3d_100_100.png")
tridi_1_1 <- ggdraw() + draw_image("3d_1_1.png")

grid.arrange(tridi_0_0,tridi_5_5,tridi_10_0,tridi_0_10,tridi_1_1,tridi_100_100,ncol=2,nrow=3)


```

```{r interact3D, include=TRUE,echo= FALSE}

# To explore the 3D graph, select all lines and run (alt + Enter), or change in line above r interact3D, include = TRUE

prob_3d(df_0)
prob_3d(df_05)
prob_3d(df_maxe)
prob_3d(df_maxv)
prob_3d(df_1)
prob_3d(df_r)

#Plotly seems more adapted for html, but works here
```



```{r ethnic utility individual-run,fig.width=4,fig.height= 3, fig.align="center", fig.pos="H", include=TRUE, echo=FALSE}
# ETHNIC UTILITY:
# Choose parameters for desired ethnic similar proportion (i_e, float number), left-slope utility curve (S),right-slope utility curve (M),total number of agents in the neighborhood (n), then run (green arrow top-right).
# The calculations are done for a max=8 neighbors (assuming we keep 8-patches Moore neighbor in NetLogo). Utility can be calculated with n > 8, but table row and x-axis graph will stop at 8.

i_e = 0.5   # parameters to manipulate
S = 0     # Symmetric single-peaked function: S=1,M=0
M = 0     # Linear + Constant function = S=1,M=1
n = 8     # Schelling Threshold function = S=0,M=1

f0m <- f_eth(i_e,M,0,n,S) # ethnic utility for each option, the increasing number is the number of agents of same ethnicity
f1m <- f_eth(i_e,M,1,n,S)
f2m <- f_eth(i_e,M,2,n,S)
f3m <- f_eth(i_e,M,3,n,S)
f4m <- f_eth(i_e,M,4,n,S)
f5m <- f_eth(i_e,M,5,n,S)
f6m <- f_eth(i_e,M,6,n,S)
f7m <- f_eth(i_e,M,7,n,S)
f8m <- f_eth(i_e,M,8,n,S)


Utility_E <- c(f0m,f1m,f2m,f3m,f4m,f5m,f6m,f7m,f8m)    # used to make up table and graph

M. <- rep(M,9)
S. <- rep(S,9)
prop_des <- rep(i_e,9)
num_tot <- rep(n,9)
num_sim <- seq(0, 8, by = 1)

report_E <- na.omit(data.frame(M.,S.,prop_des,num_tot,num_sim,Utility_E))

title_cond <- paste0("Desired proportion = ", i_e,"; ", "S = ", S,"; " ,"M = ", M)

plot_report_E <- ggplot(report_E,aes(num_sim,Utility_E))

suppressWarnings(suppressMessages(
plot_report_E + geom_point() + theme_bw() + labs(x = "Number similar agents in j",y = "Ethnic Utility j") + ggtitle(label = title_cond) + theme(plot.title = element_text(hjust = 0.5)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25)) + scale_x_continuous(limits =  c(0,n), breaks = seq(0,n,by = 1))
))

suppressWarnings(suppressMessages(
knitr::kable(report_E,align="c")
))



```


```{r value individual run,fig.width=5, fig.height= 3, fig.align="center", fig.pos="H", include=TRUE, echo=FALSE }
# VALUE UTILITY:
# Choose parameters for ethnic weight of agent i (e_w), desired value distance (i_v), left-slope utility curve (S),right-slope utility curve (M).
# The calculations are done for each ethnic weight mean of the neighborhood, from 0 to 1. The extreme case is desired value distance 1, meaning all mean ethnic weight of the neighborhood are included. Values of i_v > 1 would not affect results, but nonsense 


e_w <- 0.4    # parameters to manipulate
i_v <- 0
S  <- 0
M <- 0 

fv0d2 <- f_val(e_w,0,M,i_v,S)      # value utility for each option, the increasing number is the ethnic weight of neighborhood j
fv1d2 <- f_val(e_w,0.1,M,i_v,S)
fv2d2 <- f_val(e_w,0.2,M,i_v,S)
fv3d2 <- f_val(e_w,0.3,M,i_v,S)
fv4d2 <- f_val(e_w,0.4,M,i_v,S)
fv5d2 <- f_val(e_w,0.5,M,i_v,S)
fv6d2 <- f_val(e_w,0.6,M,i_v,S)
fv7d2 <- f_val(e_w,0.7,M,i_v,S)
fv8d2 <- f_val(e_w,0.8,M,i_v,S)
fv9d2 <- f_val(e_w,0.9,M,i_v,S)
fv10d2 <- f_val(e_w,1.0,M,i_v,S)


Utility_V <- c(fv0d2,fv1d2,fv2d2,fv3d2,fv4d2,fv5d2,fv6d2,fv7d2,fv8d2,fv9d2,fv10d2)  # used to make up table and graph

mean_ew_ng <- seq(0.0, 1.0, by = 0.1)
ew_agent <- rep(e_w,11)
Mv <- rep(M,11)
Sv <- rep(S,11)
des_dist <- rep(i_v,11)

report_V <- na.omit(data.frame(Mv,Sv,des_dist,ew_agent,mean_ew_ng,Utility_V))

title_cond_V <- paste0("Ethnic weight i = ", e_w,"; desired distance i = ",i_v,"\n\r","M =", M,"; ", "S = ",S)

plot_report_V <- ggplot(report_V,aes(mean_ew_ng,Utility_V))

suppressWarnings(suppressMessages(
plot_report_V + geom_point() + theme_bw() + labs(x = "Mean ethnic weight j",y = "Value Utility j") + ggtitle(label = title_cond_V) + theme(plot.title = element_text(hjust = 0.5)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25)) + scale_x_continuous(limits =  c(0,1), breaks = seq(0,1,by = 0.1))
))

suppressWarnings(suppressMessages(
knitr::kable(report_V,align = "c")
))

```

```{r logistic, fig.width=5,fig.height=4,fig.align='left',include=TRUE, echo=FALSE}

magic_for()

e_w <- 0.5
v_w <- 0.5
k <- 10

for (d_u_e in seq (-1.0,1.0, by = 0.1)){
  


dis_1neg   <- prob(d_u_e,-1.0,e_w,v_w,k)
dis_0.9neg <- prob(d_u_e,-0.9,e_w,v_w,k)
dis_0.8neg <- prob(d_u_e,-0.8,e_w,v_w,k)
dis_0.7neg <- prob(d_u_e,-0.7,e_w,v_w,k)
dis_0.6neg <- prob(d_u_e,-0.6,e_w,v_w,k)
dis_0.5neg <- prob(d_u_e,-0.5,e_w,v_w,k)
dis_0.4neg <- prob(d_u_e,-0.4,e_w,v_w,k)
dis_0.3neg <- prob(d_u_e,-0.3,e_w,v_w,k)
dis_0.2neg <- prob(d_u_e,-0.2,e_w,v_w,k)
dis_0.1neg <- prob(d_u_e,-0.1,e_w,v_w,k)
dis_0   <- prob(d_u_e,0.0,e_w,v_w,k)
dis_0.1 <- prob(d_u_e,0.1,e_w,v_w,k)
dis_0.2 <- prob(d_u_e,0.2,e_w,v_w,k)
dis_0.3 <- prob(d_u_e,0.3,e_w,v_w,k)
dis_0.4 <- prob(d_u_e,0.4,e_w,v_w,k)
dis_0.5 <- prob(d_u_e,0.5,e_w,v_w,k)
dis_0.6 <- prob(d_u_e,0.6,e_w,v_w,k)
dis_0.7 <- prob(d_u_e,0.7,e_w,v_w,k)
dis_0.8 <- prob(d_u_e,0.8,e_w,v_w,k)
dis_0.9 <- prob(d_u_e,0.9,e_w,v_w,k)
dis_1   <- prob(d_u_e,1.0,e_w,v_w,k)

  
  value_difference <- seq(-1.0,1.0, by = 0.1)
  
  prob_choice <- c(dis_1neg,dis_0.9neg,dis_0.8neg,dis_0.7neg,dis_0.6neg,dis_0.5neg,dis_0.4neg,dis_0.3neg,dis_0.2neg,dis_0.1neg,dis_0,dis_0.1,dis_0.2,dis_0.3,dis_0.4,dis_0.5,dis_0.6,dis_0.7,dis_0.8,dis_0.9,dis_1)
 
 
  title_cond_prob <- paste0("Diff. Ethnic Utility (alternative - current): ",d_u_e)
  title_caption <-  paste0("Ethnic weight = ",e_w*10," ; ","Value weight = ",v_w*10
                           ,"\n\r","-1: Min Utility Alternative; 1: Max Utility Alternative"
                           )
   
  report_prob <- na.omit(data.frame(value_difference,prob_choice))
  
  plot_report_prob <- ggplot(report_prob,aes(value_difference,prob_choice))
  
 final_prob <-  suppressWarnings(suppressMessages(
    plot_report_prob + geom_point() + theme_bw() + labs(x = "Diff. Value Utility (alternative - current)",y = "Probability") +
      labs(title=title_cond_prob, caption = title_caption)
      
      + theme(plot.title = element_text(hjust = 0.5),plot.caption = element_text(hjust=0.5)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25)) + scale_x_continuous(limits =  c(-1,1), breaks = seq(-1,1,by = 0.2)) + geom_vline(xintercept = 0, colour = "red", linetype = "dotted") + geom_hline(yintercept = 0.5, colour = "red", linetype = "dotted") 
  ))
  
  plot(final_prob)
  

  
}


```

```{r test, fig.width=5,fig.height=4,fig.align='left',include=TRUE, echo=FALSE}

e_w_v <- 0.5
v_w_v <- 1-e_w_v
k_v <- 10
  
dfprob_log <- mutate(dfprob,e_w=e_w_v,v_w=v_w_v,k=k_v, probalog = prob(d_u_e, d_u_v,e_w,v_w,k))



#  report_prob <- na.omit(dfprob_log(d_u_v,probalog))


logi <- function(lo){
plot_report_prob <- ggplot(dfprob_log[which(d_u_e == lo),],aes(d_u_v,probalog))



  title_cond_prob <- paste0("Diff. Ethnic Utility (alternative - current): ",lo)
  title_caption <-  paste0("Ethnic weight = ",e_w_v*k_v," ; ","Value weight = ",v_w_v*k_v
                           ,"\n\r","-1: Min Utility Alternative; 1: Max Utility Alternative"
                           )


 final_prob <-  suppressWarnings(suppressMessages(
    plot_report_prob + geom_point() + theme_bw() + labs(x = "Diff. Value Utility (alternative - current)",y = "Probability") +
      labs(title=title_cond_prob, caption = title_caption)

      + theme(plot.title = element_text(hjust = 0.5),plot.caption = element_text(hjust=0.5)) + scale_y_continuous(limits =  c(0.0,1.0), breaks = seq(0.0,1.0,by = 0.25)) + scale_x_continuous(limits =  c(-1,1), breaks = seq(-1,1,by = 0.2)) + geom_vline(xintercept = 0, colour = "red", linetype = "dotted") + geom_hline(yintercept = 0.5, colour = "red", linetype = "dotted")
  ))

 final_prob
 
}

logi(-1)
logi(-0.9)




}


```


# References
