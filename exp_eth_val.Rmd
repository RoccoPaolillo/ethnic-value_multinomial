---
output:
  bookdown::pdf_document2:
    toc: false
    keep_tex: true
    fig_caption: yes
title: "Observations"
# subtitle: "Target: BIGSSS Research Day"
author: Rocco Paolillo 
  
# date: JU 
#language: en-GB
bibliography: "references.bib"
# always_allow_html: yes

# target: BIGSSS Research Day by September 15th, presented  on October 25th. 6000 words: around 12 pages.
# csl: apa.csl # by default: Chicago style
header-includes:
- \usepackage{float}
- \usepackage{multirow}
- \usepackage{xcolor} 
- \usepackage{amsmath}
- \usepackage{graphicx}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.lp="fig:"  ,warning = FALSE)

library(knitr)
library(ggplot2)
library(forcats)
library(reshape2)
library(tidyr)
library(dplyr)
library(reshape)
library(ggpubr)
library(magick)
library(gridExtra)
library(grid)

#theme_set(theme_pubr())

wd <- setwd("C:/Users/rocpa/OneDrive/Desktop/AF/")
dataone <- read.csv("experiments/80_50_onebeta.csv",sep = ";",skip = 1)
datatwo <- read.csv("experiments/two_beta.csv", sep = ";",skip = 1)


dataone$rev_circle_orange <- fct_rev(factor(dataone$circle_orange))
dataone$rev_circle_blue <- fct_rev(factor(dataone$circle_blue))

datatwo$rev_beta_iv_circle <- fct_rev(factor(datatwo$beta_iv_circle))
datatwo$rev_beta_ie_square <- fct_rev(factor(datatwo$beta_ie_square))

  rev_circle_blue.labs <- c("80% Circle \nBlue" ,"50% Circle \nBlue","20% Circle \nBlue")
names(rev_circle_blue.labs) <- c("80", "50","20")
 rev_circle_orange.labs <-  c("80% Circle \nOrange", "50% Circle \nOrange","20% Circle \nOrange")
names(rev_circle_orange.labs) <- c("80", "50","20")

 circle_blue.labs <- c("20% Circle \nBlue", "50% Circle \nBlue","80% Circle \nBlue")
names(circle_blue.labs) <- c("20", "50","80")
 circle_orange.labs <-  c("20% Circle \nOrange", "50% Circle \nOrange","80% Circle \nOrange")
names(circle_orange.labs) <- c("20", "50","80")


```
\newcommand*{\thead}[1]{\multicolumn{1}{c}{\bfseries #1}}



# Recap

- Research question: How the interplay of ethnic and value homophily preferences can explain difference in the degree of integration for the members of the same ethnic group (hybrid segregation) for both ethnic and value segregation.
- Focus: different weight on ethnic homogeneity ($\beta_e$) and value homogeneity ($\beta_v$), heterogeneity among agents, relative group size for both dimensions \par

Utility of agents in Schelling relocation

$$
U= \beta_eX_v + \beta_vX_v + \epsilon
$$

```{r thheory, fig.pos="h", out.width="50%",out.width='\\textwidth',fig.align='left',fig.show="hold", fig.cap="Agents distinction (subgroups) and utility function", echo=FALSE, include=TRUE }

knitr::include_graphics("recapp.png")
```






# First Section, relative group size & homogeneous preferences (Tab: \ref{tab:First})

* Aim:
    + Effect of different homophily preferences: direct effect of $\beta_e$ on ethnic segregation, and direct effect of beta value $\beta_v$ on value segregation; how $\beta_v$ influences effect of  $\beta_e$ on ethnic segregation and how $\beta_e$ influences effect of $\beta_v$ on value segregation
* Focus: relative group size for ethnicity and value distribution within each ethnic group, considering how they directly influence probability to sort with similars; interaction with levels of $\beta_e$,$\beta_v$
* Assumptions: 
    + not heterogeneity: all agents hold both ethnic preference (same color) and value preference (same shape) depending on level of global $\beta_e$ and $\beta_v$
    + equal ethnic size (blue/orange: $0.50$) vs majority/minority (blue/orange: $0.80$)
    + value distribution within each ethnic group: proportion circle/square, moving from minority circle to majority cirlce:  $0.20$,$0.50$,$0.80$. It can be seen as moving from more intolerant to  more intolerant society when value-dependent heterogeneous preferences are included. In this section, there is not heterogeneous preferences
* Figures:
    + Fig: \ref{fig:baselineone} represents how results are presented through the space of the model. I identified $\beta =5$ for both ethnic and value preferences as threshold between area of high randomness and low randomness. Results can be explained as within the space resulting from area of high randomness and low randomness (i.e. high systematic component) for ethnic and value utility.
    + Relative group sizes: the bold frame in Fig: \ref{fig:global} would represent the baseline, where each subgroup in Fig: \ref{fig:thheory} represents the $25 \%$ of the population and has probability $0.25$ to meet an agent of same ethnicity and same value (baseline: blue/orange = $0.5$ and within each ethnic group cirlce/square = $0.5$)
    + Relative group sizes (value orientation): in each figure from Fig: \ref{fig:global} to Fig: \ref{fig:crlblmajority} along the diagonal, moves from minority circle (low corner) in the population to majority circle (upper corner)
    + x-axis = ethnic weight $\beta_e$, y-axis = value weight $\beta_v$





\begin{table}[H]
\begin{tabular}{llll}
\midrule
 Static agent variable                      & Range         &      &                \\ \midrule
 Ethnicity  (\textit{color})         & Blue, Orange        \\
 Value orientation (\textit{shape}) & Square, Circle &  &  \\
 \midrule
 
 Parameters kept constant    & Slider & Range   & Experiments  \\ 
 \midrule
 Population density    & density                 & $[0,0.99]$   & $0.7$          \\
 Peak ethnic utility & similar\_wanted\_ethnic & $[0,1]$ & $1$ (linear function) \\
 Peak value utility & similar\_wanted\_value & $[0,1]$ & $1$ (linear function) \\
 \midrule
 \textbf{Parameters modified in experiment} & \textbf{Slider} & \textbf{Range}   & \textbf{Experiments}  \\ 
 \midrule
 Ethnic group ratio (local\/minority)  & fraction\_blue &  $[0,1]$      & $0.5,0.8$  \\
 value ratio  blue population & circle\_blue & $[0,1]$      & $0.20,0.5,0.8$  \\
 value ratio  orange population & circle\_blue & $[0,1]$      & $0.20,0.5,0.8$  \\
 Determinism ethnic utility ($\beta_e$) & beta-ie for all agents & $[0,10]$ & $[0,10]$  \\
 Determinism value utility ($\beta_v$) & beta-iv for all agents & $[0,10]$ & $[0,10]$ \\
 \midrule
 Global output measures    & Computation &   Range & \\ 
 \midrule
 Ethnic segregation  & same color neighborhood $\%$ & $0,\stackrel{+0.1}{\dots}, 1$ & global and subgroups\\
 Value segregation  & same shape neighborhood $\%$  & $0,\stackrel{+0.1}{\dots}, 1$ & global and subgroups\\
   \midrule
Number of Runs   & 1 & Numer of steps & 1000 \\ 
 \midrule
\end{tabular}
 \caption{First Section} 
 \label{tab:First}
\end{table}



```{r baselineone,fig.pos='H',out.width="96%",fig.show = "hold",fig.align='center', fig.cap="Space of model", echo=FALSE, include=TRUE  }

knitr::include_graphics("baseline_1.png")

```


## Global value and  ethnic segregation (Fig: \ref{fig:global}, Fig: \ref{fig:global-maj})

* Fig: \ref{fig:global}: equal ethnic size, Fig: \ref{fig:global-maj}: majority/minority condition
* Ethnic segregation increases along the axis of $\beta_e$, while value segregation symmetrically along the axis of $\beta_v$. In both cases $\beta = 5$ seems a critical limit between high randomness and low randomness (high systematic utility). Consequently, area in the space $\beta < 5$ is closer  to ethnic and value integration, due to random relocation, area $\beta >= 5$ shows complete segregation because of the systematic component
* While ethnic and value segregation linearly increase for the high randomness area below  $\beta = 5$, segregation for both dimensions for $\beta > 5$ seems homogeneous at high level
* The limit of $\beta = 5$ to me can relate to "sensitivity to change" in @van2009neighborhood: since the shape of utility is linearly increasing, each difference in neighborhood composition corresponds to a change in utility. The product $\beta * \Delta Utility$ is affected by randomness only for very low levels of $\beta$, with $\beta =5$ it becomes too strong: agents are too sensitive to the systematic utility, moving to the neighborhood with the higher utility, affecting its composition, which will increase the utility difference and attractiveness of the neighborhood to agents in next step, falling shortly into complete segregation. Difference for higher levels of $\beta = 5$ is negligible.
* At $\beta = 0$ for each dimnension, increase in the other $\beta$ ($\beta_v$ on $\beta_e$ and $\beta_e$ on $\beta_v$) does not produce effects, apart in the area of high randomness when one value group represents the minority in one ethnicity and the majority on the other (upper left and lower right panel). Affected  by relocation of majority value.
* Condition of ethnic majority/minority shows basically the same patterns, slightly higher ethnic segregation for the area of high randomness, which is direct effect of unequal group sizes.

    


```{r global, fig.height=8.8, fig.pos="H", include=TRUE, fig.cap="Global Segregation with ethnic equal group size, baseline in boldline", echo=FALSE}

# gen_eq <- filter(dataone, fraction_blue == 50 & step == 1000)
# gen_mj <- filter(dataone, fraction_blue == 80 & step == 1000)


 circle_local.labs <- c("20% Circle \nBlue", "50% Circle \nBlue","80% Circle \nBlue")
names(circle_local.labs) <- c("20", "50","80")
 circle_minority.labs <-  c("20% Circle \nOrange","50% Circle \nOrange","80% Circle \nOrange")
names(circle_minority.labs) <- c("20", "50","80")

  rev_circle_blue.labs <- c("80% Circle \nBlue" ,"50% Circle \nBlue","20% Circle \nBlue")
names(rev_circle_blue.labs) <- c("80", "50","20")
 rev_circle_orange.labs <-  c("80% Circle \nOrange", "50% Circle \nOrange","20% Circle \nOrange")
names(rev_circle_orange.labs) <- c("80", "50","20")


# eth_mj <- ggplot(gen_mj, aes( beta_iv, beta_ie,fill= eth_seg))
# val_mj <- ggplot(gen_mj, aes( beta_iv, beta_ie,fill= val_seg))
# 


eth_eq <- ggplot(data=subset(dataone,fraction_blue == 50 & step == 1000), aes( beta_ie, beta_iv,fill= eth_seg)) + geom_tile() +   facet_grid(rev_circle_orange  ~  circle_blue,  space = "free_x", labeller = labeller(circle_blue = circle_local.labs,  rev_circle_orange = rev_circle_orange.labs ), switch  = "y")  +
  scale_fill_distiller(name = "ETHNIC",palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) + 
  scale_x_discrete(name = "ß ethnic", limits=seq(0,10 ,by = 1)) + 
  scale_y_discrete(name = "ß value", limits=c(0,3,5,7,10), position = "right")   + 
  theme_bw() + theme(strip.text.x = element_text(), legend.position = "right", panel.grid.minor.x = element_blank(), plot.title=element_blank(),  legend.margin=margin(0,0,0,0)) +
   geom_rect(data=subset(dataone,fraction_blue == 50 & step == 1000 & circle_orange == 50 & circle_blue == 50),aes(xmin = -1,xmax = 12, ymin = -1, ymax = 11),colour="black",size =2,alpha = 0)


val_eq <- ggplot(data=subset(dataone,fraction_blue == 50 & step == 1000), aes( beta_ie, beta_iv,fill= val_seg)) + geom_tile() +   facet_grid(rev_circle_orange  ~  circle_blue,  space = "free_x", labeller = labeller(circle_blue = circle_local.labs,  rev_circle_orange = rev_circle_orange.labs ), switch  = "y")  + 
  scale_fill_distiller(name = "VALUE",palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) + 
  scale_x_discrete(name = "ß ethnic", limits=seq(0,10 ,by = 1)) + 
  scale_y_discrete(name = "ß value", limits=c(0,3,5,7,10), position = "right")  + 
  theme_bw() + theme(strip.text.x = element_text(), legend.position = "right", panel.grid.minor.x = element_blank(), plot.title=element_blank(),  legend.margin=margin(0,0,0,0)) +
  geom_rect(data=subset(dataone,fraction_blue == 50 & step == 1000 & circle_orange == 50 & circle_blue == 50),aes(xmin = -1,xmax = 12, ymin = -1, ymax = 11),colour="black",size =2,alpha = 0)


glb <- annotate_figure(ggarrange(eth_eq , ggarrange(val_eq), nrow = 2), top = text_grob("Global Segregation, Blue:Orange = 0.5:0.5",face = "bold", size = 12))

glb

```


```{r global-maj, fig.height=8.8, fig.pos="H",  include=TRUE, fig.cap="Global Segregation with majority/minority ethnicity, baseline in boldline", echo=FALSE}

# gen_eq <- filter(dataone, fraction_blue == 50 & step == 1000)
# gen_mj <- filter(dataone, fraction_blue == 80 & step == 1000)


 circle_local.labs <- c("20% Circle \nBlue", "50% Circle \nBlue","80% Circle \nBlue")
names(circle_local.labs) <- c("20", "50","80")
 circle_minority.labs <-  c("20% Circle \nOrange","50% Circle \nOrange","80% Circle \nOrange")
names(circle_minority.labs) <- c("20", "50","80")




# eth_mj <- ggplot(gen_mj, aes( beta_iv, beta_ie,fill= eth_seg))
# val_mj <- ggplot(gen_mj, aes( beta_iv, beta_ie,fill= val_seg))
# 


maj_eth <- ggplot(data=subset(dataone,fraction_blue == 80 & step == 1000), aes( beta_ie, beta_iv,fill= eth_seg)) + geom_tile() +   facet_grid(rev_circle_orange  ~  circle_blue,  space = "free_x", labeller = labeller(circle_blue = circle_local.labs,  rev_circle_orange = rev_circle_orange.labs ), switch  = "y")  +
  scale_fill_distiller(name = "ETHNIC",palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) + 
  scale_x_discrete(name = "ß ethnic", limits=seq(0,10 ,by = 1)) + 
  scale_y_discrete(name = "ß value", limits=c(0,3,5,7,10), position = "right") + 
  theme_bw() + theme(strip.text.x = element_text(), legend.position = "right", panel.grid.minor.x = element_blank(), plot.title=element_blank(),  legend.margin=margin(0,0,0,0)) +
  geom_rect(data=subset(dataone,fraction_blue == 80 & step == 1000 & circle_orange == 50 & circle_blue == 50),aes(xmin = -1,xmax = 12, ymin = -1, ymax = 11),colour="black",size =2,alpha = 0)


maj_val <- ggplot(data=subset(dataone,fraction_blue == 80 & step == 1000), aes( beta_ie, beta_iv,fill= val_seg)) + geom_tile() +   facet_grid(rev_circle_orange  ~  circle_blue,  space = "free_x", labeller = labeller(circle_blue = circle_local.labs,  rev_circle_orange = rev_circle_orange.labs ), switch  = "y")  +
  scale_fill_distiller(name = "VALUE",palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) + 
 scale_x_discrete(name = "ß ethnic", limits=seq(0,10 ,by = 1)) + 
  scale_y_discrete(name = "ß value", limits=c(0,3,5,7,10), position = "right")  + 
  theme_bw() + theme(strip.text.x = element_text(), legend.position = "right", panel.grid.minor.x = element_blank(), plot.title=element_blank(),  legend.margin=margin(0,0,0,0)) +
  geom_rect(data=subset(dataone,fraction_blue == 80 & step == 1000 & circle_orange == 50 & circle_blue == 50),aes(xmin = -1,xmax = 12, ymin = -1, ymax = 11),colour="black",size =2,alpha = 0)


maj_glb <- annotate_figure(ggarrange(maj_eth , ggarrange(maj_val), nrow = 2), top = text_grob("Global Segregation, Blue:Orange = 0.8:0.2",face = "bold", size = 12))
maj_glb


```


## Subgroup behavior (Fig: \ref{fig:crlo} to Fig: \ref{fig:crlblmajority})

* Circle orange is used as model for equal ethnic size and ethnic group in the minority condition. Circle  blue as model for ethnic group in majority condition. The observed behavior can be applied symmetrically to the other subgroups imposing same conditions, I do this in ANNEX A rotating the axes.
* 3 outcomes are evident, rather than 2 as in traditional assessment of Schelling: integration (filler white  0.5), segregation (filler red above 0.5), and assimilation (filler blue close to 0, only members outgroup). This can relate as measure of *hybrid segregation*

### Equal ethnic group size (Fig: \ref{fig:crlo})

* Baseline reproduces the same as global observations. Ethnic segregation doesn't change along the diagonal; value segregation does, as effect of different value distribution (minority circle in the low left; majority circle in the upper right)
* Top left corner, circle is majority value in the own ethnic group (orange), minority value in the other ethnicity (blue): integration occurs in the high randomnessfor both preferences (low left corner); ethnic segregation in high random ethnic area increases with increase of $\beta_v$; increase also of value segregation for increase in $\beta_e$: Both results  are due to the majority value circle increasing both value and  ethnic preferences, in condition of equal ethnic size.
* Top row: proceding on x-axis with increase in percentage similar value in the other ethnic group: for area of ethnic randomness, ethnic integration more evident over ethnic segregation at increase of $\beta_v$, because more equal chance to satisfy value preferences with agents of both ethnic groups
* Bottom left corner, circle value is minority value in both groups: value assimilation to square happens for all levels of $\beta_e$, as direct consequence of minority position. Ethnic integration emerges for high ethnic randomness ($\beta_e=5$)  also for increase in $\beta_v$, because agents need to cluster with value similars of the other ethnic group, which still are a minority. Value segregation results constantly high for all area  $\beta_v \geq 5$. Still, looking at overlap of ethnic and value space, moving from high ethnic randomness to low ethnic randomness area, ethnic integration shifts to ethnic segregation. This means that agents still manage to live in neighborhoods value homogeneous, but only with members of the own ethnic group. Maybe good to include density observation here, and compare with ACS.
* Bottom row: proceding on x-axis with increase of circle in the other ethnic group: value assimilation for $\beta_v < 5$ narrows down to high $\beta_e$, since for random ethnic behavior there is more chance to find value similar circle in the other group. When value preference increases along $\beta_v$, ethnic assimilation becomes more evident since circle have more chance to find similar value, though of the other ethnic group, which they don't care about.
* Middle row (circle are 50% value in ethnic group): transition in between observations above, not  different patters


```{r crlo,fig.pos='H',out.width='\\textwidth',fig.show = "hold",fig.align='center', fig.cap="Circle orange, equal ethnic size", echo=FALSE, include=TRUE  }



dataone %>%  filter(fraction_blue == 50) %>%  gather(key = subgroup, value = Segra, eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_cl_or","Ethnic" = "eth_cl_or"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid(rev_circle_orange ~ circle_blue + segregation, labeller = labeller(rev_circle_orange = rev_circle_orange.labs, circle_blue = circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Circle orange, equal ethnic size") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )


```


### Ethnic minority (Fig: \ref{fig:crlominority})

* Baseline shows ethnic assimilation for the area of high ethnic randomness $\beta_e < 5$, direct effect of numeric minority
* Top left corner, circle is majority value in the own ethnic minority (orange), minority value in the ethnic majority (blue): in both areas of high randomness (bottom left corner), strong ethnic assimilation and mild value assimilation emerge. Due to unbalance of circle in ethnic minority and ethnic majority, for random moves  circle orange have more chance to relocate close to an agent of ethnic majority, but the probability of this agent being value circle or square becomes slightly  similar. Increasing value preference for $\beta_v \geq 5$, tendence towards ethnic integration occurs rather than assimilation or segregation, still value segregation is almost complete. This because due to value and ethnic distribution, the probability of an agent being circle blue or circle orange is equally $\approx 0.15$, thus, increasing value preference and not caring for ethnicity, circle minority form neighborhoods value homogeneous but ethnically mixed
* Top row: increasing circle value in the ethnic majority (along x-axis), at circle ethnic majority = $50 \%$, value integration occurs for high ethnic randomness.Increasing $\beta_v$, ethnic assimilation emerges along value segregation more evidently, since now circle is majority value in the ethnic minority, but equally represented at $0.50$ in the ethnic blue majority, thus the probability to find a circle blue is higher than finding a circle orange.
* Bottom left corner, circle value is minority value in both groups: compared to Fig: \ref{fig:crlo}, ethnic and value assimilation for respective $\beta < 5$ and ethnic and value segregation for $\beta \geq 5$ remains, though less evident in particular for low randomness area $\beta \geq 5$, due to numeric minority.
* Bottom row: increasing circle value in the ethnic majority (along x-axis), increase in $\beta_v$ for the area of ethnic randomness favors ethnic assimilation, which expands also to the area of high ehtnic utility ($\beta_e \geq 5$) as circle value are most represented in the ethnic majority. Here, to satisfy highest levels of value homophily, minority circle must reduce on ethnic homophily, which for the borderline area $\beta = 5$ allows for spillover of value preference on ethnic segregation. Increase in $\beta_e$ shows value assimilation narrowly for highest ethnic preferences $\beta \geq 5$ rather than uniformly as in Fig: \ref{fig:crlo}, because to maximize ethnic preference circle orange need to cluster to square who represent the majority value in their ethnic minority. The shift from value assimilation towards segregation for random ethnic moves $\beta_e < 5$ is because there is more probability now of a circle being from ethnic blue majority.


```{r crlominority,fig.pos='H',out.width='\\textwidth',fig.show = "hold",fig.align='center', fig.cap="Circle orange, ethnic minority", echo=FALSE, include=TRUE  }


dataone %>%  filter(fraction_blue == 80) %>%  gather(key = subgroup, value = Segra, eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_cl_or","Ethnic" = "eth_cl_or"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid(rev_circle_orange ~ circle_blue + segregation, labeller = labeller(rev_circle_orange = rev_circle_orange.labs, circle_blue = circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Circle orange, ethnic minority") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )

#grid.arrange(grob(sqroeq),grob(sqromj), ncol =  1, common.legend = TRUE,legend = "bottom") 

```

### Ethnic majority (Fig: \ref{fig:crlblmajority})

* First column, where circle represent the value minority in the ethnic blue majority: value assimilation is homogeneous for $\beta_e$, due to value minority. Ethnic segregation for high ethnic randomness $\beta_e < 5$ moves from integration to segregation as the number of circle in the ethnic orange minority decreases: to maximize value preference, circle blue will form value homogeneous neighborhoods, and the higher percentage of value circle in ethnic minority allows to increase the random probability of circle value being blue either orange, causing ethnic integration. As the concentration of value orange decreases, the random probability of circle being co-ethnic blue increases, favoring ethnic segregation.



```{r crlblmajority, fig.pos='H',out.width='\\textwidth',fig.show = "hold",fig.align='center',fig.show="hold", fig.cap="Circle blue, ethnic majority", echo=FALSE, include=TRUE}

 circle_blue.labs <- c("20% Circle \nBlue", "50% Circle \nBlue","80% Circle \nBlue")
names(circle_blue.labs) <- c("20", "50","80")
 circle_orange.labs <-  c("20% Circle \nOrange", "50% Circle \nOrange","80% Circle \nOrange")
names(circle_orange.labs) <- c("20", "50","80")

  rev_circle_blue.labs <- c("80% Circle \nBlue" ,"50% Circle \nBlue","20% Circle \nBlue")
names(rev_circle_blue.labs) <- c("80", "50","20")

 rev_circle_orange.labs <-  c("80% Circle \nOrange", "50% Circle \nOrange","20% Circle \nOrange")
names(rev_circle_orange.labs) <- c("80", "50","20")

dataone %>%  filter(fraction_blue == 80) %>%  gather(key = subgroup, value = Segra, eth_cl_bl,val_cl_bl) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_cl_bl","Ethnic" = "eth_cl_bl"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid( rev_circle_orange   ~  circle_blue + segregation, labeller = labeller(rev_circle_orange =rev_circle_orange.labs, circle_blue = circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Circle blue, ethnic majority") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )

```



# Second Section, heterogeneous (hierarchical?) preferences value vs ethnicity (Tab: \ref{tab:Second})

* Aim:
    + Test the effect of heterogeneous preferences depending on value attribution: circle care more about value neighborhood composition, square care more about ethnic neighborhood composition.
    + This is the case  we discussed, adapting to circle tolerant, square intolerant
    + How preference heterogeneity affects results in  the previous section, where agents hold  same preference
    + How mutual adaptation of circle and square driven by different hierarchy of preference affect each other segregation patterns
    + Interaction of heterogeneous preferences with relative group size for ethnic and value membership
* Assumptions: 
    + square hold higher ethnic than value preferences: $\beta^{\square}_e \geq \beta^{\square}_v$; circle hold higher value than ethnic preferences: $\beta^{\circ}_v \geq \beta^{\circ}_e$.
    + No difference due to ethnic membership
    + \textbf{NOTE: Here only baseline} for question of time/computation server (Tab: \ref{tab:Second}). I'd collect conditions of majority and minority circle or square in ethnic different group sizes.
* Figures
    + Circle orange and square orange is taken as prototype (in the legend circle, square), since any subgroup in Fig: \ref{fig:thheory} has same probability $0.25$ to relocate close similar one and behavior would be symmetrical \textbf{-> agree? I would test otherwise}
    + Need to find trade off between 4 parameters (see Tab: \ref{tab:Second}) and behavior of 2 type of agents (circle and blue) in conditions of relative group size
    + Considering the critical levels of $\beta = 5$ between high randomness and low randomness (space model Fig: \ref{fig:baselineone}), I jump here directly to critical points $\beta = 0$: total ranomness,  $\beta = 5$: min determinism, $\beta = 10$: max determinism, this for each dimensions and faceting for circle and value group.
    + ANNEX B heatmaps: ethnic and value segregation for all preferences of square faceted for the 3 critical points of circle (Fig: \ref{fig:heatmapdsquare}); ethinic and value segregation for all preferences of circle faceted for the 3 critical points of square (Fig: \ref{fig:heatmapdcircle})
    + Fig: \ref{fig:betatwoethnic} and Fig: \ref{fig:betatwovalue} compares in the same graph ethnic and value segregation for circle and square agents, narrowing down compared to ANNEX B. Focus: the lower the distance between ethnic and value segregation, the more the agent relocates close to a members of the own ethnic and value subgroup (Fig: \ref{fig:thheory}) 
    


\begin{table}[H]
\begin{tabular}{llll}
\midrule
 Static agent variable                      & Range         &      &                \\ \midrule
 Ethnicity  (\textit{color})         & Blue, Orange        \\
 Value orientation (\textit{shape}) & Square, Circle &  &  \\
 \midrule
 
 Parameters kept constant    & Slider & Range   & Experiments  \\ 
 \midrule
 Population density    & density                 & $[0,0.99]$   & $0.7$          \\
 Peak ethnic utility & similar\_wanted\_ethnic & $[0,1]$ & $1$ (linear function) \\
 Peak value utility & similar\_wanted\_value & $[0,1]$ & $1$ (linear function) \\
 \midrule
 \textbf{Parameters modified in experiment} & \textbf{Slider} & \textbf{Range}   & \textbf{Experiments}  \\ 
 \midrule
 Ethnic group ratio (local\/minority)  & fraction\_blue &  $[0,1]$      & $0.5$  \\
 value ratio  blue population & circle\_blue & $[0,1]$      & $0.5$  \\
 value ratio  orange population & circle\_blue & $[0,1]$      & $0.5$  \\
 Determinism ethnic utility square ($\beta^{\square}_e$) & beta-ie-sqr & $[0,10]$ & $[0,10]$  \\
 Determinism value utility square ($\beta^{\square}_v$) & beta-iv-sqr  & $[0,10]$ & $[0,10], if \beta^{\square}_v \leq \beta^{\square}_e$ \\
 Determinism value utility circle ($\beta^{\circ}_v$) & beta-iv-crl  & $[0,10]$ & $[0,10]$  \\
 Determinism ethnic utility circle ($\beta^{\circ}_e$) & beta-ie-crl & $[0,10]$ & $[0,10], if \beta^{\circ}_e \leq \beta^{\circ}_v$  \\
 \midrule
 Global output measures    & Computation &   Range & \\ 
 \midrule
 Ethnic segregation  & same color neighborhood $\%$ & $0,\stackrel{+0.1}{\dots}, 1$ & global and subgroups\\
 Value segregation  & same shape neighborhood $\%$ & $0,\stackrel{+0.1}{\dots}, 1$ & global and subgroups\\
   \midrule
Number of Runs   & 1 & Number of steps & 1000 \\ 
 \midrule
\end{tabular}
 \caption{Second section: heterogeneous preferences} 
 \label{tab:Second}
\end{table}

## Focus on square preferences (Fig: \ref{fig:betatwoethnic})
* x-axis: difference preferences for square $\beta^{\square}_e - \beta^{\square}_e$. x-axis: 0: ethnic and value matter equally with same high $\beta$ to square ($\beta^{\square}_e = \beta^{\square}_v = 5$ top panel, $\beta^{\square}_e = \beta^{\square}_v = 10$ lower panel); proceding on x-axis, ethnic matters more to square than value ($\beta^{\square}_e$ is constant, while $\beta^{\square}_v$ decreases to 0)
* y-axis: ethnic and value segregation for circle and square
* bottom left box, where all circle relocate randomly ($\beta$ circle = 0):
   + bottom panel (high determinism): decline of value segregation for both groups occurs mostly linear monotonic for all values of $\beta^{\square}_v$
   + ethnic segregation of square population is lower than in other conditions, due to random relocation of circle, both for high ethnic and lower ethnic determinism (top and bottom figure)
* along the diagonal, as circle population increases equally ethnic and value determinism: 
   + value segregation for both groups decreases along x-axis, where value matters progressively less for square, given the constant level of square ethnic preference
   + decline of value segregation above happens in high value randomness when $\beta^{\square}_v \leq 5$: top panel: all conditions; bottom panel: right side of red line (10-5 = 5)
   + curve of value segregation decline is steeper in all conditions of the bottom panel (higher determinism $\beta^{\square}_e = 10$)
* above diagonal, ethnic and value segregation of square population decline the most for high values of $\beta^{\square}_e$ when circle relocate randomly for ethnicity. I relate this to high randomness of $\beta^{\square}_v < 5$: all conditions top panel, but only right side of red line, where $\beta^{\square}_v < 5$. The trend is higher in the top panel of high randomness. Basically seems high value and ethnic determinism of square support each other on relative segregation when the other circle group  relocates randomly.



## Focus on circle preferences (Fig: \ref{fig:betatwovalue})
* x-axis: difference preferences for circle $\beta^{\circ}_v - \beta^{\circ}_e$. x-axis: 0: ethnic and value matter equally with same high $\beta$ to square ($\beta^{\circ}_v - \beta^{\circ}_e = 5$ top panel, $\beta^{\circ}_v - \beta^{\circ}_e = 510$ lower panel); proceding on x-axis, value matters more to circle than value ($\beta^{\circ}_v$ is constant, while $\beta^{\circ}_e$ decreases to 0)
* y-axis: ethnic and value segregation for circle and square
* bottom left box, where all square relocate randomly ($\beta$ circle = 0):
* Basically the extreme of the pictures can be deduced from Fig: \ref{fig:betatwovalue}, inverting circle and value positions
* along the x-axis, as $\beta^{\circ}_e$ decreases, ethnic segregation decreases linearly, though it reaches always complete ethnic integration compared to Fig: \ref{fig:betatwoethnic}. This happens for $\beta^{\circ}_e < 5$ (all conditions top panel and right side of bottom panel), and for all levels  of $\beta^{\circ}_e$ when square moves randomly for value homophily (first column in bottom panel). This last note is the same as bottom left box in bottom panel in Fig: \ref{fig:betatwoethnic}. The random relocation of square favors  the complete ethnic integration
* first column, along the x-axis, where value homophily becomes more important to circle and ethnicity moves  to 0, and square don't care about value, but more on ethnicity (from  $\beta^{\square}_e = 5$ to $\beta^{\square}_e = 10$ ). Distance between value and ethnic segregation shows that circle live in value homogeneous but ethnically mixed neighborhoods, square in both ethnically and value homogeneous neighborhoods (i.e. with square of same ethncity). My guess: square would be attracted by neighborhoods of circle, because there is more chance to find a co-ethnic, though they would be refused because of their value by circle who maximize value homophily. In the condition of lower determinism $\beta^{\square}_e = 5$, square would still relocate randomly in the world, not threating the value composition of circle neighborhoods. When ethnic square determinism increases to $\beta^{\square}_e = 10$, then ethnically mixed neighborhoods of circle become highly appealing and try to move there. At next step, circle would refuse square because of  value homophily and would move to value homogeneous neighborhoods (playing with simulations, seems to less dense neighborhoods, might be included). As for square of different ethncity, clearly they would not live close to each other for direct effect of increase in ethnic determinism. Due to reinforce in value homophily for circle and ethnic homophily for square, equilibria emerge with 3 clusters: circle live in complete ethnically mixed, but complete value segregated neighborhoods, square in both ethnically and value segregated neighborhoods (i.e. square with the same ethncity). The value segregation of square is  basically emerging un-intended consequence of adaptation between ethnic homophily of square  and value homophily of circle. 



```{r betatwoethnic,fig.pos='H',fig.out="96%",fig.show = "hold",fig.align='center',fig.cap="Difference segregation, x-axis: difference ethnic and value preference square, faceting conditions: preferences of circle", echo=FALSE, include=TRUE }

circle_frame <- datatwo %>% filter(step == 1000) %>% filter(beta_iv_circle == 0 |beta_iv_circle == 5 |beta_iv_circle == 10 ) %>% filter(beta_ie_circle == 0 | beta_ie_circle == 5 | beta_ie_circle == 10) 


rev_beta_iv_circle.labs <- c("Circle ß value 10" ,"Circle ß value 5", "Circle ß value 0")
names(rev_beta_iv_circle.labs) <- c("10", "5","0")
beta_ie_circle.labs <- c("Circle \nß ethnic 0", "Circle \nß ethnic 5","Circle \nß ethnic 10")
names(beta_ie_circle.labs) <- c("0", "5","10")


#  v_circle.labs <- c("ß value circle 0", "ß value circle 5", "ß value circle 10")
# names(v_circle.labs) <- c("0", "5","10")
e_circle.labs <- c("Circle ß ethnic 0", "Circle ß ethnic 5", "Circle ß ethnic 10")
names(e_circle.labs) <- c("0", "5","10")

  
ie_10 <- circle_frame %>%  filter(beta_ie_square == 10) %>% gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or,eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"ethnic segregation" = c("eth_sq_or","eth_cl_or"), "value segregation" = c("val_sq_or","val_cl_or")), "ethnic segregation"), `group` = fct_relevel(fct_collapse(subgroup, "square" = c("eth_sq_or","val_sq_or"), "circle" = c("eth_cl_or","val_cl_or"), "square"))) %>%
  ggplot(aes(x = (beta_ie_square - beta_iv_square), y = Segra, color = `segregation`, shape = `group`)) + geom_line() + geom_point( size = 2) + facet_grid(rev_beta_iv_circle ~  beta_ie_circle, labeller = labeller(rev_beta_iv_circle = rev_beta_iv_circle.labs,  beta_ie_circle = e_circle.labs )) +
  geom_vline(xintercept = 5, color = "red") +
  scale_x_discrete(name = "ß ethnic square 10 - ß value square", limits = seq(0,10, by = 1)) +  ylab("Segregation") +
  scale_color_manual(values = c("dark violet","dark green"), guide = guide_legend(title="")) +
  scale_shape_manual(values = c(16,15), guide = guide_legend(title="")) +
    theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0))

ie_5 <- circle_frame %>%  filter(beta_ie_square == 5) %>% gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or,eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"ethnic segregation" = c("eth_sq_or","eth_cl_or"), "value segregation" = c("val_sq_or","val_cl_or")), "ethnic segregation"), `group` = fct_relevel(fct_collapse(subgroup, "square" = c("eth_sq_or","val_sq_or"), "circle" = c("eth_cl_or","val_cl_or"), "square"))) %>%
  ggplot(aes(x = (beta_ie_square - beta_iv_square), y = Segra, color = `segregation`, shape = `group`)) + geom_line() + geom_point( size = 2) + facet_grid(rev_beta_iv_circle ~  beta_ie_circle, labeller = labeller(rev_beta_iv_circle = rev_beta_iv_circle.labs,  beta_ie_circle = e_circle.labs )) +
  scale_x_discrete(name = "ß ethnic square 5 - ß value square", limits = seq(0,5, by = 1)) +  ylab("Segregation") +
  scale_color_manual(values = c("dark violet","dark green"), guide = guide_legend(title="")) +
  scale_shape_manual(values = c(16,15), guide = guide_legend(title="")) +
    theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0))

ie_5
ie_10
```






```{r betatwovalue,  fig.pos="H",fig.out="96%",fig.show = "hold", fig.align='center',fig.show="hold", fig.cap="Difference segregation between", echo=FALSE, include=TRUE  }

circle_frame <- datatwo %>% filter(step == 1000) %>% filter(beta_ie_square == 0 |beta_ie_square == 5 |beta_ie_square == 10 ) %>% filter(beta_iv_square == 0 | beta_iv_square == 5 | beta_iv_square == 10) 


rev_beta_ie_square.labs <- c("Square \nß ethnic 10" ,"Square \nß ethnic 5", "Square \nß ethnic 0")
names(rev_beta_ie_square.labs) <- c("10", "5","0")

e_square.labs <- c("ß ethnic \nsquare 0", "ß ethnic \nsquare 5", "ß ethnic \nsquare 10")
names(e_square.labs) <- c("0", "5","10")
v_square.labs <- c("ß value square 0", "ß value square 5", "ß value square 10")
names(v_square.labs) <- c("0", "5","10")
 
  
iv_10 <- circle_frame %>%  filter(beta_iv_circle == 10) %>% gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or,eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"ethnic segregation" = c("eth_sq_or","eth_cl_or"), "value segregation" = c("val_sq_or","val_cl_or")), "ethnic segregation"), `group` = fct_relevel(fct_collapse(subgroup, "square" = c("eth_sq_or","val_sq_or"), "circle" = c("eth_cl_or","val_cl_or"), "square")))  %>%
  ggplot(aes(x = (beta_iv_circle - beta_ie_circle), y = Segra, color = `segregation`, shape = `group`)) + geom_line() + geom_point( size = 2) + facet_grid(rev_beta_ie_square ~  beta_iv_square, labeller = labeller(rev_beta_ie_square = rev_beta_ie_square.labs, beta_iv_square = v_square.labs))  +
  geom_vline(xintercept = 5, color = "red") +
  scale_x_discrete(name = "ß value circle 10 - ß ethnic circle", limits = seq(0,10, by = 1)) +  ylab("Segregation") +
  scale_color_manual(values = c("dark violet","dark green"), guide = guide_legend(title="")) +
  scale_shape_manual(values = c(16,15), guide = guide_legend(title="")) +
    theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0))

iv_5 <- circle_frame %>%  filter(beta_iv_circle == 5) %>% gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or,eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"ethnic segregation" = c("eth_sq_or","eth_cl_or"), "value segregation" = c("val_sq_or","val_cl_or")), "ethnic segregation"), `group` = fct_relevel(fct_collapse(subgroup, "square" = c("eth_sq_or","val_sq_or"), "circle" = c("eth_cl_or","val_cl_or"), "square")))  %>%
  ggplot(aes(x = (beta_iv_circle - beta_ie_circle), y = Segra, color = `segregation`, shape = `group`)) + geom_line() + geom_point( size = 2) + facet_grid(rev_beta_ie_square ~  beta_iv_square, labeller = labeller(rev_beta_ie_square = rev_beta_ie_square.labs, beta_iv_square = v_square.labs))  +
  scale_x_discrete(name = "ß value circle 5 - ß ethnic circle", limits = seq(0,5, by = 1)) +  ylab("Segregation") +
  scale_color_manual(values = c("dark violet","dark green"), guide = guide_legend(title="")) +
  scale_shape_manual(values = c(16,15), guide = guide_legend(title="")) +
    theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0))

iv_5
iv_10

```



# ANNEX A {-} 




```{r sqro, fig.pos='H',out.width='\\textwidth',fig.show = "hold",fig.align='center',fig.show="hold", fig.cap="First Section, Square Orange", echo=FALSE, include=TRUE  }


sqroeq <- dataone %>%  filter(fraction_blue == 50) %>%  gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_sq_or","Ethnic" = "eth_sq_or"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid(circle_orange ~ rev_circle_blue + segregation, labeller = labeller(circle_orange = circle_orange.labs, rev_circle_blue = rev_circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Square orange, equal ethnic size") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )


sqroqmj <- dataone %>%  filter(fraction_blue == 80) %>%  gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_sq_or","Ethnic" = "eth_sq_or"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid(circle_orange ~ rev_circle_blue + segregation, labeller = labeller(circle_orange = circle_orange.labs, rev_circle_blue = rev_circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Square orange, ethnic minority") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )



sqroeq
sqroqmj
```


```{r crlbl,fig.pos='H' ,out.width='\\textwidth',fig.show = "hold",fig.align='center',fig.show="hold", fig.cap="First Section, Circle Blue", echo=FALSE, include=TRUE}


 rev_circle_orange.labs <-  c("80% Circle \nOrange", "50% Circle \nOrange","20% Circle \nOrange")
names(rev_circle_orange.labs) <- c("80", "50","20")

 circle_blue.labs <- c("20% Circle \nBlue", "50% Circle \nBlue","80% Circle \nBlue")
names(circle_blue.labs) <- c("20", "50","80")


crlbeq <- dataone %>%  filter(fraction_blue == 50) %>%  gather(key = subgroup, value = Segra, eth_cl_bl,val_cl_bl) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_cl_bl","Ethnic" = "eth_cl_bl"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid( rev_circle_blue  ~ circle_orange  + segregation, labeller = labeller(circle_orange =circle_orange.labs, rev_circle_blue = rev_circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Circle blue, equal ethnic size") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )


crlbmj <- dataone %>%  filter(fraction_blue == 80) %>%  gather(key = subgroup, value = Segra, eth_cl_bl,val_cl_bl) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_cl_bl","Ethnic" = "eth_cl_bl"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid( rev_circle_blue  ~ circle_orange  + segregation, labeller = labeller(circle_orange =circle_orange.labs, rev_circle_blue = rev_circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Circle blue, ethnic majority") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )


#grid.arrange(grob(sqroeq),grob(sqromj), ncol =  1, common.legend = TRUE,legend = "bottom") 

 crlbeq
 crlbmj
```


```{r sqrbl, fig.pos='H' ,out.width='\\textwidth',fig.show = "hold",fig.align='center',fig.show="hold", fig.cap="First Section, Square Blue", echo=FALSE, include=TRUE}


sqrbeq <- dataone %>%  filter(fraction_blue == 50) %>%  gather(key = subgroup, value = Segra, eth_sq_bl,val_sq_bl) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_sq_bl","Ethnic" = "eth_sq_bl"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid(circle_blue ~  rev_circle_orange  + segregation, labeller = labeller(rev_circle_orange = rev_circle_orange.labs, circle_blue = circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Square blue, equal ethnic size") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )


sqrbomj <- dataone %>%  filter(fraction_blue == 80) %>%  gather(key = subgroup, value = Segra, eth_sq_bl,val_sq_bl) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_sq_bl","Ethnic" = "eth_sq_bl"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid(circle_blue ~  rev_circle_orange  + segregation, labeller = labeller(rev_circle_orange = rev_circle_orange.labs, circle_blue = circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Square blue, ethnic majority") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )



sqrbeq
sqrbomj
```


# ANNEX B  {-} 


```{r heatmapdsquare,fig.pos='H',out.width='\\textwidth',fig.show = "hold",fig.align='center', fig.cap="Square orange, heterogenous preferences", echo=FALSE, include=TRUE }

circle_frame <- datatwo %>% filter(step == 1000) %>% filter(beta_iv_circle == 0 |beta_iv_circle == 5 |beta_iv_circle == 10 ) %>% filter(beta_ie_circle == 0 | beta_ie_circle == 5 | beta_ie_circle == 10) 

rev_beta_iv_circle.labs <- c("Circle \nß value 10" ,"Circle \nß value 5", "Circle \nß value 0")
names(rev_beta_iv_circle.labs) <- c("10", "5","0")
beta_ie_circle.labs <- c("Circle \nß ethnic 0", "Circle \nß ethnic 5","Circle \nß ethnic 10")
names(beta_ie_circle.labs) <- c("0", "5","10")

  
circle_frame %>%   gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"ETHNIC" = "eth_sq_or", "VALUE" = "val_sq_or"), "ethnic segregation")) %>%
  ggplot(aes(x = beta_iv_square, y = beta_ie_square, fill = Segra)) + geom_tile() + facet_grid(rev_beta_iv_circle ~  beta_ie_circle + segregation, labeller = labeller(rev_beta_iv_circle = rev_beta_iv_circle.labs, beta_ie_circle = beta_ie_circle.labs)) +
   scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5)) +
 xlab("ß value square") + ylab("ß ethnic square") + ggtitle("Square orange, baseline") + 
    theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0))

```


```{r heatmapdcircle, fig.pos='H',out.width='\\textwidth',fig.show = "hold",fig.align='center', fig.cap="Circle orange, heterogeneous preferences", echo=FALSE, include=TRUE }

circle_frame <- datatwo %>% filter(step == 1000) %>% filter(beta_ie_square == 0 |beta_ie_square == 5 |beta_ie_square == 10 ) %>% filter(beta_iv_square == 0 | beta_iv_square == 5 | beta_iv_square == 10) 



rev_beta_ie_square.labs <- c("Square \nß ethnic 10" ,"Square \nß ethnic 5","Square \nß ethnic 0")
names(rev_beta_ie_square.labs) <- c("10", "5","0")
beta_iv_square.labs <- c("Square \nß value 0", "Square \nß value 5","Square \nß value 10")
names(beta_iv_square.labs) <- c("0", "5","10")

  
circle_frame %>%   gather(key = subgroup, value = Segra, eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"ETHNIC" = "eth_cl_or", "VALUE" = "val_cl_or"), "ethnic segregation")) %>%
  ggplot(aes(x = beta_ie_circle, y = beta_iv_circle, fill = Segra)) + geom_tile() + facet_grid(rev_beta_ie_square ~  beta_iv_square + segregation, labeller = labeller(rev_beta_ie_square = rev_beta_ie_square.labs, beta_iv_square = beta_iv_square.labs)) +
   scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5)) +
 xlab("ß ethnic circle") + ylab("ß value circle") + ggtitle("Circle orange, baseline") + 
    theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0))

```






# References {-}




















