---
output:
  bookdown::pdf_document2:
    toc: false
 #   keep_tex: false
    fig_caption: yes
title: "Observations"
# subtitle: "Target: BIGSSS Research Day"
author: Rocco Paolillo 
  
# date: JU 
#language: en-GB
#bibliography: "references.bib"
# always_allow_html: yes

# target: BIGSSS Research Day by September 15th, presented  on October 25th. 6000 words: around 12 pages.
# csl: apa.csl # by default: Chicago style
header-includes:
- \usepackage{float}
- \usepackage{multirow}
- \usepackage{xcolor} 
- \usepackage{amsmath}
- \usepackage{graphicx}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.lp="fig:",warning = FALSE)

library(knitr)
library(ggplot2)
library(forcats)
library(reshape2)
library(tidyr)
library(dplyr)
library(reshape)
library(ggpubr)
library(magick)
library(gridExtra)
library(grid)

#theme_set(theme_pubr())

wd <- setwd("C:/Users/rocpa/OneDrive/Desktop/AF/")
dataone <- read.csv("experiments/80_50_onebeta.csv",sep = ";",skip = 1)
datatwo <- read.csv("experiments/two_beta.csv", sep = ";",skip = 1)


dataone$rev_circle_orange <- fct_rev(factor(dataone$circle_orange))
dataone$rev_circle_blue <- fct_rev(factor(dataone$circle_blue))

datatwo$rev_beta_iv_circle <- fct_rev(factor(datatwo$beta_iv_circle))
datatwo$rev_beta_ie_square <- fct_rev(factor(datatwo$beta_ie_square))

  rev_circle_blue.labs <- c("80% Circle \nBlue" ,"50% Circle \nBlue","20% Circle \nBlue")
names(rev_circle_blue.labs) <- c("80", "50","20")
 rev_circle_orange.labs <-  c("80% Circle \nOrange", "50% Circle \nOrange","20% Circle \nOrange")
names(rev_circle_orange.labs) <- c("80", "50","20")

 circle_blue.labs <- c("20% Circle \nBlue", "50% Circle \nBlue","80% Circle \nBlue")
names(circle_blue.labs) <- c("20", "50","80")
 circle_orange.labs <-  c("20% Circle \nOrange", "50% Circle \nOrange","80% Circle \nOrange")
names(circle_orange.labs) <- c("20", "50","80")


```
\newcommand*{\thead}[1]{\multicolumn{1}{c}{\bfseries #1}}



# Recap

- Research question: How the interplay of ethnic and value homophily preferences can explain difference in the degree of integration for the members of the same ethnic group (hybrid segregation) for both ethnic and value segregation.
- Focus: different weight on the two dimensions, heterogeneity among agents, relative group size for both dimensions \par

Utility of agents in Schelling relocation

$$
U= \beta_eX_v + \beta_vX_v + \epsilon
$$

```{r thheory, fig.pos="h", out.width="50%",out.width='\\textwidth',fig.align='left',fig.show="hold", fig.cap="Agents distinction and utility function", echo=FALSE, include=TRUE }

knitr::include_graphics("recapp.png")
```






# First Section (effect of relative group size)

* Aim:
    + Effect of different homophily preferences: direct effect of $\beta_e$ on ethnic segregation, and direct effect of beta value $\beta_v$ on value segregation, and reciprocal influences, i.e. how of $\beta_v$ influences effect of  $\beta_e$ on ethnic segregation and how $\beta_e$ influences effect of $\beta_v$ on value segregation
* Focus: interaction between relative group size for each dimension with degree of $\beta$, since group size directly influence the probability to find similar ones and the systematic utility computed for each neighborhood
* Assumption: 
    + not heterogeneity: all agents hold both ethnic preference (same color) and value preference (same shape)
    + ethnic size at global level: equal size (blue/orange: $0.50$), majority/minority (blue/orange: $0.80$)
    + value size within each ethnic group: minority circle circle/square $0.20$, equal size circle/square $0.50$, majority circle circle/square $0.80$, imagining tolerant (circle) and intolerant (square),this means to move from more tolerant to less tolerant groups, both majority and minority. In this section there is not difference in preferences implied.
* Figures:
    + Fig: \ref{fig:baselineone} represents how results are presented through the space of the model. Axis represent the ratio of $circle/square$ in each ethnic group, expressed as percentage: on y-axis the percentage of circle value in the orange ethnic group, on the x-axis the percentage of circle value in the blue ethnic group. The percentage of square agents can be calculated from it. The \textbf{baseline} condition is represented by the black dot, where each ethnicity is split equally into the two value groups ($0.50$ circle, $0.50$ square); following the diagonal, each ethnic group moves from minority circle to majority circle. Each obervation is repeated  for ethnic equal group sizes (blue/orange = $0.50$) and ethnic majority/minority condition (blue/orange = $0.80$). In the baseline condition for equal ethnic size, each group $valueXethnicity$ represents the $25 \%$ of the overall population. This means each agent in Fig: \ref{fig:thheory} has potentially probability $0.25$ to relocate close to someone who shares both ethnicity and value orientation.
    + In all results $\beta = 5$ seems a threshold between area of high randomness and low randomness. I would use this as reference point in describing figures and change in conditions



Table \ref{tab:first}

\begin{table}[H]
\begin{tabular}{llll}
\midrule
 Static agent variable                      & Range         &      &                \\ \midrule
 Ethnicity  (\textit{color})         & Blue, Orange        \\
 Value orientation (\textit{shape}) & Square, Circle &  &  \\
 \midrule
 
 Parameters kept constant    & Slider & Range   & Experiments  \\ 
 \midrule
 Population density    & density                 & $[0,0.99]$   & $0.7$          \\
 Peak ethnic utility & similar\_wanted\_ethnic & $[0,1]$ & $1$ (linear function) \\
 Peak value utility & similar\_wanted\_value & $[0,1]$ & $1$ (linear function) \\
 \midrule
 \textbf{Parameters modified in experiment} & \textbf{Slider} & \textbf{Range}   & \textbf{Experiments}  \\ 
 \midrule
 Ethnic group ratio (local\/minority)  & fraction\_blue &  $[0,1]$      & $0.5,0.8$  \\
 value ratio  blue population & circle\_blue & $[0,1]$      & $0.20,0.5,0.8$  \\
 value ratio  orange population & circle\_blue & $[0,1]$      & $0.20,0.5,0.8$  \\
 Determinism ethnic utility ($\beta_e$) & beta-ie for all agents & $[0,1]$ & $[0,10]$  \\
 Determinism value utility ($\beta_v$) & beta-iv for all agents & $[0,1]$ & $[0,10]$ \\
 \midrule
 Global output measures    & Computation &   Range & \\ 
 \midrule
 Ethnic segregation  & same color neighborhood proportion & $0,\stackrel{+0.1}{\dots}, 1$ & global and subgroups\\
 Value segregation  & same shape neighborhood proportion & $0,\stackrel{+0.1}{\dots}, 1$ & global and subgroups\\
   \midrule
\end{tabular}
\label{tab:first}
 \caption{Basic Model} 


\end{table}

* Global Observations:
    + Fig: \ref{fig:global} and  Fig: \ref{fig:global-maj} shows the global ethnic and value segregation, for equal ethnic group sizes in Fig: \ref{fig:global}  and majority/minority ethnic condition in Fig: \ref{fig:global-maj}  . The heatmaps report in each condition  $\beta_e$ on x-axis, and  $\beta_v$ on y-axis. 
    + Ethnic segregation increases along the axis of $\beta_e$, while value segregation symmetrically along the axis of $\beta_v$. In both cases $\beta = 5$ shows a threshold between areas of integration and area of segregation.
    + While area below $\beta = 5$ is linearly increasing, areas above $\beta = 5$ seem to show same degree of high segregation. Attributing this to randomness component, I would identify area $\beta < 5$ as low randomness, area  $\beta \geq 5$ high randomness, and focus on threshold of $\beta = 5$, this helps presenting figures later
    + The direct effect of $\beta_e$ on ethnic segregation and  $\beta_v$ on value segregation seems unaffected by the other systemic component, both when  $\beta = 0$, so that agents relocate randomly for value or ethnic homophily, and when they increase the systemic utility for either ethnic (increase in  $\beta_e$) or value homophily (increase in $\beta_v$)
    + Condition of ethnic majority/minority shows basically the same patterns, slighter high ethnic segregation for the area of high randomness, which is direct effect of unequal group sizes.
    + Change in ethnic segregation compared to the baseline seem to occur only along the diagonal, where circle orientation represents the minority in one group and majority in the other, or vice versa. Similar slightly changes occur in the area of high randomness $\beta_e < 5$ with increase of $\beta_v$, which is counterintuitive. Circle of both ethnic group not care about ethnic composition of the neighborhood, but they care about the value composition. Since in one ethnic group circle represent the value majority, and in the other the circle minority, circle in the minority condition will result in ethnically mixed or majority out-group neighborhoods, circle in the majority in ethnically homogeneous neighborhoods, since they have more probability to find someone circle of the own ethnic group than the other. So, for these agents ethnic segregation is the more likely outcome, also if the systematic component of utility is for value segregation and ethnic utility random. The global results are influenced by the numeric superiority of these  agents.
    + Next figures look at the behavior of specific subgroup in Fig. \ref{fig:thheory}
    

```{r baselineone,fig.pos='H',out.width='\\textwidth',fig.show = "hold",fig.align='center', fig.cap=" Baseline space", echo=FALSE, include=TRUE  }

knitr::include_graphics("baseline_1.png")

```


```{r global, fig.height=8.8, fig.pos="H", include=TRUE, fig.cap="Global Segregation with ethnic equal group size, baseline in boldline", echo=FALSE}

# gen_eq <- filter(dataone, fraction_blue == 50 & step == 1000)
# gen_mj <- filter(dataone, fraction_blue == 80 & step == 1000)


 circle_local.labs <- c("20% Circle \nBlue", "50% Circle \nBlue","80% Circle \nBlue")
names(circle_local.labs) <- c("20", "50","80")
 circle_minority.labs <-  c("20% Circle \nOrange","50% Circle \nOrange","80% Circle \nOrange")
names(circle_minority.labs) <- c("20", "50","80")




# eth_mj <- ggplot(gen_mj, aes( beta_iv, beta_ie,fill= eth_seg))
# val_mj <- ggplot(gen_mj, aes( beta_iv, beta_ie,fill= val_seg))
# 


eth_eq <- ggplot(data=subset(dataone,fraction_blue == 50 & step == 1000), aes( beta_ie, beta_iv,fill= eth_seg)) + geom_tile() +   facet_grid(circle_orange  ~  circle_blue,  space = "free_x", labeller = labeller(circle_blue = circle_local.labs,  circle_orange = circle_minority.labs ))  +
  scale_fill_distiller(name = "ETHNIC",palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) + 
  scale_x_discrete(name = "ß ethnic", limits=seq(0,10 ,by = 1)) + 
  scale_y_discrete(name = "ß value", limits=c(0,3,5,7,10))   + 
  theme_bw() + theme(strip.text.x = element_text(), legend.position = "right", panel.grid.minor.x = element_blank(), plot.title=element_blank(),  legend.margin=margin(0,0,0,0)) +
   geom_rect(data=subset(dataone,fraction_blue == 50 & step == 1000 & circle_orange == 50 & circle_blue == 50),aes(xmin = -1,xmax = 12, ymin = -1, ymax = 11),colour="black",size =2,alpha = 0)


val_eq <- ggplot(data=subset(dataone,fraction_blue == 50 & step == 1000), aes( beta_ie, beta_iv,fill= val_seg)) + geom_tile() +   facet_grid(circle_orange  ~  circle_blue,  space = "free_x", labeller = labeller(circle_blue = circle_local.labs,  circle_orange = circle_minority.labs )) + 
  scale_fill_distiller(name = "VALUE",palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) + 
  scale_x_discrete(name = "ß ethnic", limits=seq(0,10 ,by = 1)) + 
  scale_y_discrete(name = "ß value", limits=c(0,3,5,7,10))  + 
  theme_bw() + theme(strip.text.x = element_text(), legend.position = "right", panel.grid.minor.x = element_blank(), plot.title=element_blank(),  legend.margin=margin(0,0,0,0)) +
  geom_rect(data=subset(dataone,fraction_blue == 50 & step == 1000 & circle_orange == 50 & circle_blue == 50),aes(xmin = -1,xmax = 12, ymin = -1, ymax = 11),colour="black",size =2,alpha = 0)


glb <- annotate_figure(ggarrange(eth_eq , ggarrange(val_eq), nrow = 2), top = text_grob("Global Segregation, Blue:Orange = 0.5:0.5",face = "bold", size = 12))

glb

```


```{r global-maj, fig.height=8.8, fig.pos="H",  include=TRUE, fig.cap="Global Segregation with majority/minority ethnicity, baseline in boldline", echo=FALSE}

# gen_eq <- filter(dataone, fraction_blue == 50 & step == 1000)
# gen_mj <- filter(dataone, fraction_blue == 80 & step == 1000)


 circle_local.labs <- c("20% Circle \nBlue", "50% Circle \nBlue","80% Circle \nBlue")
names(circle_local.labs) <- c("20", "50","80")
 circle_minority.labs <-  c("20% Circle \nOrange","50% Circle \nOrange","80% Circle \nOrange")
names(circle_minority.labs) <- c("20", "50","80")




# eth_mj <- ggplot(gen_mj, aes( beta_iv, beta_ie,fill= eth_seg))
# val_mj <- ggplot(gen_mj, aes( beta_iv, beta_ie,fill= val_seg))
# 


maj_eth <- ggplot(data=subset(dataone,fraction_blue == 80 & step == 1000), aes( beta_ie, beta_iv,fill= eth_seg)) + geom_tile() +   facet_grid(circle_orange  ~  circle_blue,  space = "free_x", labeller = labeller(circle_blue = circle_local.labs,  circle_orange = circle_minority.labs ))  +
  scale_fill_distiller(name = "ETHNIC",palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) + 
  scale_x_discrete(name = "ß ethnic", limits=seq(0,10 ,by = 1)) + 
  scale_y_discrete(name = "ß value", limits=c(0,3,5,7,10)) + 
  theme_bw() + theme(strip.text.x = element_text(), legend.position = "right", panel.grid.minor.x = element_blank(), plot.title=element_blank(),  legend.margin=margin(0,0,0,0)) +
  geom_rect(data=subset(dataone,fraction_blue == 80 & step == 1000 & circle_orange == 50 & circle_blue == 50),aes(xmin = -1,xmax = 12, ymin = -1, ymax = 11),colour="black",size =2,alpha = 0)


maj_val <- ggplot(data=subset(dataone,fraction_blue == 80 & step == 1000), aes( beta_ie, beta_iv,fill= val_seg)) + geom_tile() +   facet_grid(circle_orange  ~  circle_blue,  space = "free_x", labeller = labeller(circle_blue = circle_local.labs,  circle_orange = circle_minority.labs )) + 
  scale_fill_distiller(name = "VALUE",palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) + 
 scale_x_discrete(name = "ß ethnic", limits=seq(0,10 ,by = 1)) + 
  scale_y_discrete(name = "ß value", limits=c(0,3,5,7,10))  + 
  theme_bw() + theme(strip.text.x = element_text(), legend.position = "right", panel.grid.minor.x = element_blank(), plot.title=element_blank(),  legend.margin=margin(0,0,0,0)) +
  geom_rect(data=subset(dataone,fraction_blue == 80 & step == 1000 & circle_orange == 50 & circle_blue == 50),aes(xmin = -1,xmax = 12, ymin = -1, ymax = 11),colour="black",size =2,alpha = 0)


maj_glb <- annotate_figure(ggarrange(maj_eth , ggarrange(maj_val), nrow = 2), top = text_grob("Global Segregation, Blue:Orange = 0.8:0.2",face = "bold", size = 12))
maj_glb


```


* Observations for group $ethnicityXvalue$:
    + I report the results of circle orange in the condition of ethnic equal size, ethnic minority and ethnic majority. Since agents  follow the same homophily preferences, the only difference is due to the manipulation of relative group sizes for ethnicity and value orientation, so that the results here presented can be applied to all other group by rotating the axis on Fig: \ref{fig:baselineone} or results along the diagonal. I do this in the ANNEX as demonstration





```{r crlo,fig.pos='H',out.width='\\textwidth',fig.show = "hold",fig.align='center', fig.cap="Circle orange, first section", echo=FALSE, include=TRUE  }



crloeq <- dataone %>%  filter(fraction_blue == 50) %>%  gather(key = subgroup, value = Segra, eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_cl_or","Ethnic" = "eth_cl_or"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid(rev_circle_orange ~ circle_blue + segregation, labeller = labeller(rev_circle_orange = rev_circle_orange.labs, circle_blue = circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Circle orange, equal ethnic size") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )


crlomj <- dataone %>%  filter(fraction_blue == 80) %>%  gather(key = subgroup, value = Segra, eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_cl_or","Ethnic" = "eth_cl_or"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid(rev_circle_orange ~ circle_blue + segregation, labeller = labeller(rev_circle_orange = rev_circle_orange.labs, circle_blue = circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Circle orange, ethnic minority") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )

#grid.arrange(grob(sqroeq),grob(sqromj), ncol =  1, common.legend = TRUE,legend = "bottom") 

 crloeq
 crlomj
```



```{r crlblmajority, fig.pos='t',out.width='\\textwidth',fig.show = "hold",fig.align='center',fig.show="hold", fig.cap="Circle in majority condition.", echo=FALSE, include=TRUE}

  rev_circle_blue.labs <- c("80% Circle \nBlue" ,"50% Circle \nBlue","20% Circle \nBlue")
names(rev_circle_blue.labs) <- c("80", "50","20")

 rev_circle_orange.labs <-  c("80% Circle \nOrange", "50% Circle \nOrange","20% Circle \nOrange")
names(rev_circle_orange.labs) <- c("80", "50","20")

dataone %>%  filter(fraction_blue == 80) %>%  gather(key = subgroup, value = Segra, eth_cl_bl,val_cl_bl) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_cl_bl","Ethnic" = "eth_cl_bl"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid( rev_circle_blue  ~ circle_orange  + segregation, labeller = labeller(circle_orange =circle_orange.labs, rev_circle_blue = rev_circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Circle blue, ethnic majority") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )

```



# Effect of value distribution in group value differences

Each graph is one level of $\%$ circle (value 1) in the local population (majority = blue agents). Each condition panel refers to distribution of  circle agents in the minority population.


```{r heatmapdsquare,fig.pos='t',out.width='\\textwidth',fig.show = "hold",fig.align='center', fig.cap="Square orange, heterogenous preferences", echo=FALSE, include=TRUE }

circle_frame <- datatwo %>% filter(step == 1000) %>% filter(beta_iv_circle == 0 |beta_iv_circle == 5 |beta_iv_circle == 10 ) %>% filter(beta_ie_circle == 0 | beta_ie_circle == 5 | beta_ie_circle == 10) 

rev_beta_iv_circle.labs <- c("Circle \nß value 10" ,"Circle \nß value 5", "Circle \nß value 0")
names(rev_beta_iv_circle.labs) <- c("10", "5","0")
beta_ie_circle.labs <- c("Circle \nß ethnic 0", "Circle \nß ethnic 5","Circle \nß ethnic 10")
names(beta_ie_circle.labs) <- c("0", "5","10")

  
circle_frame %>%   gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"ETHNIC" = "eth_sq_or", "VALUE" = "val_sq_or"), "ethnic segregation")) %>%
  ggplot(aes(x = beta_iv_square, y = beta_ie_square, fill = Segra)) + geom_tile() + facet_grid(rev_beta_iv_circle ~  beta_ie_circle + segregation, labeller = labeller(rev_beta_iv_circle = rev_beta_iv_circle.labs, beta_ie_circle = beta_ie_circle.labs)) +
   scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5)) +
 xlab("ß value square") + ylab("ß ethnic square") + ggtitle("Square orange, baseline") + 
    theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0))

```

```{r heatmapdcircle, fig.pos='t',out.width='\\textwidth',fig.show = "hold",fig.align='center', fig.cap="Circle orange, heterogeneous preferences", echo=FALSE, include=TRUE }

circle_frame <- datatwo %>% filter(step == 1000) %>% filter(beta_ie_square == 0 |beta_ie_square == 5 |beta_ie_square == 10 ) %>% filter(beta_iv_square == 0 | beta_iv_square == 5 | beta_iv_square == 10) 



rev_beta_ie_square.labs <- c("Square \nß ethnic 10" ,"Square \nß ethnic 5","Square \nß ethnic 0")
names(rev_beta_ie_square.labs) <- c("10", "5","0")
beta_iv_square.labs <- c("Square \nß value 0", "Square \nß value 5","Square \nß value 10")
names(beta_iv_square.labs) <- c("0", "5","10")

  
circle_frame %>%   gather(key = subgroup, value = Segra, eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"ETHNIC" = "eth_cl_or", "VALUE" = "val_cl_or"), "ethnic segregation")) %>%
  ggplot(aes(x = beta_ie_circle, y = beta_iv_circle, fill = Segra)) + geom_tile() + facet_grid(rev_beta_ie_square ~  beta_iv_square + segregation, labeller = labeller(rev_beta_ie_square = rev_beta_ie_square.labs, beta_iv_square = beta_iv_square.labs)) +
   scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5)) +
 xlab("ß ethnic circle") + ylab("ß value circle") + ggtitle("Circle orange, baseline") + 
    theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0))

```



```{r betatwoethnic,fig.pos='t',out.width="96%",fig.show = "hold",fig.align='center',fig.cap="Difference segregation", echo=FALSE, include=TRUE }

circle_frame <- datatwo %>% filter(step == 1000) %>% filter(beta_iv_circle == 0 |beta_iv_circle == 5 |beta_iv_circle == 10 ) %>% filter(beta_ie_circle == 0 | beta_ie_circle == 5 | beta_ie_circle == 10) 


rev_beta_iv_circle.labs <- c("Circle ß value 10" ,"Circle ß value 5", "Circle ß value 0")
names(rev_beta_iv_circle.labs) <- c("10", "5","0")
beta_ie_circle.labs <- c("Circle \nß ethnic 0", "Circle \nß ethnic 5","Circle \nß ethnic 10")
names(beta_ie_circle.labs) <- c("0", "5","10")


#  v_circle.labs <- c("ß value circle 0", "ß value circle 5", "ß value circle 10")
# names(v_circle.labs) <- c("0", "5","10")
e_circle.labs <- c("Circle ß ethnic 0", "Circle ß ethnic 5", "Circle ß ethnic 10")
names(e_circle.labs) <- c("0", "5","10")

  
ie_10 <- circle_frame %>%  filter(beta_ie_square == 10) %>% gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or,eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"ethnic segregation" = c("eth_sq_or","eth_cl_or"), "value segregation" = c("val_sq_or","val_cl_or")), "ethnic segregation"), `group` = fct_relevel(fct_collapse(subgroup, "square minority" = c("eth_sq_or","val_sq_or"), "circle minority" = c("eth_cl_or","val_cl_or"), "square minority"))) %>%
  ggplot(aes(x = (beta_ie_square - beta_iv_square), y = Segra, color = `segregation`, shape = `group`)) + geom_line() + geom_point() + facet_grid(rev_beta_iv_circle ~  beta_ie_circle, labeller = labeller(rev_beta_iv_circle = rev_beta_iv_circle.labs,  beta_ie_circle = e_circle.labs )) +
  geom_vline(xintercept = 5, color = "red") +
  scale_x_discrete(name = "ß ethnic square 10 - ß value square", limits = seq(0,10, by = 1)) +  ylab("Segregation") +
  scale_color_manual(values = c("dark violet","dark green"), guide = guide_legend(title="")) +
  scale_shape_manual(values = c(16,15), guide = guide_legend(title="")) +
    theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0))

ie_5 <- circle_frame %>%  filter(beta_ie_square == 5) %>% gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or,eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"ethnic segregation" = c("eth_sq_or","eth_cl_or"), "value segregation" = c("val_sq_or","val_cl_or")), "ethnic segregation"), `group` = fct_relevel(fct_collapse(subgroup, "square minority" = c("eth_sq_or","val_sq_or"), "circle minority" = c("eth_cl_or","val_cl_or"), "square minority"))) %>%
  ggplot(aes(x = (beta_ie_square - beta_iv_square), y = Segra, color = `segregation`, shape = `group`)) + geom_line() + geom_point() + facet_grid(rev_beta_iv_circle ~  beta_ie_circle, labeller = labeller(rev_beta_iv_circle = rev_beta_iv_circle.labs,  beta_ie_circle = e_circle.labs )) +
  scale_x_discrete(name = "ß ethnic square 5 - ß value square", limits = seq(0,5, by = 1)) +  ylab("Segregation") +
  scale_color_manual(values = c("dark violet","dark green"), guide = guide_legend(title="")) +
  scale_shape_manual(values = c(16,15), guide = guide_legend(title="")) +
    theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0))

ie_5
ie_10
```


```{r betatwovalue,  fig.pos="t",fig.show = "hold", fig.align='center',fig.show="hold", fig.cap="Difference segregation between", echo=FALSE, include=TRUE  }

circle_frame <- datatwo %>% filter(step == 1000) %>% filter(beta_ie_square == 0 |beta_ie_square == 5 |beta_ie_square == 10 ) %>% filter(beta_iv_square == 0 | beta_iv_square == 5 | beta_iv_square == 10) 


rev_beta_ie_square.labs <- c("Square \nß ethnic 10" ,"Square \nß ethnic 5", "Square \nß ethnic 0")
names(rev_beta_ie_square.labs) <- c("10", "5","0")

e_square.labs <- c("ß ethnic \nsquare 0", "ß ethnic \nsquare 5", "ß ethnic \nsquare 10")
names(e_square.labs) <- c("0", "5","10")
v_square.labs <- c("ß value square 0", "ß value square 5", "ß value square 10")
names(v_square.labs) <- c("0", "5","10")
 
  
iv_10 <- circle_frame %>%  filter(beta_iv_circle == 10) %>% gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or,eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"ethnic segregation" = c("eth_sq_or","eth_cl_or"), "value segregation" = c("val_sq_or","val_cl_or")), "ethnic segregation"), `group` = fct_relevel(fct_collapse(subgroup, "square minority" = c("eth_sq_or","val_sq_or"), "circle minority" = c("eth_cl_or","val_cl_or"), "square minority")))  %>%
  ggplot(aes(x = (beta_iv_circle - beta_ie_circle), y = Segra, color = `segregation`, shape = `group`)) + geom_line() + geom_point() + facet_grid(rev_beta_ie_square ~  beta_iv_square, labeller = labeller(rev_beta_ie_square = rev_beta_ie_square.labs, beta_iv_square = v_square.labs))  +
  geom_vline(xintercept = 5, color = "red") +
  scale_x_discrete(name = "ß value circle 10 - ß ethnic circle", limits = seq(0,10, by = 1)) +  ylab("Segregation") +
  scale_color_manual(values = c("dark violet","dark green"), guide = guide_legend(title="")) +
  scale_shape_manual(values = c(16,15), guide = guide_legend(title="")) +
    theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0))

iv_5 <- circle_frame %>%  filter(beta_iv_circle == 5) %>% gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or,eth_cl_or,val_cl_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"ethnic segregation" = c("eth_sq_or","eth_cl_or"), "value segregation" = c("val_sq_or","val_cl_or")), "ethnic segregation"), `group` = fct_relevel(fct_collapse(subgroup, "square minority" = c("eth_sq_or","val_sq_or"), "circle minority" = c("eth_cl_or","val_cl_or"), "square minority")))  %>%
  ggplot(aes(x = (beta_iv_circle - beta_ie_circle), y = Segra, color = `segregation`, shape = `group`)) + geom_line() + geom_point() + facet_grid(rev_beta_ie_square ~  beta_iv_square, labeller = labeller(rev_beta_ie_square = rev_beta_ie_square.labs, beta_iv_square = v_square.labs))  +
  scale_x_discrete(name = "ß value circle 10 - ß ethnic circle", limits = seq(0,5, by = 1)) +  ylab("Segregation") +
  scale_color_manual(values = c("dark violet","dark green"), guide = guide_legend(title="")) +
  scale_shape_manual(values = c(16,15), guide = guide_legend(title="")) +
    theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0))

iv_5
iv_10

```



# ANNEX




```{r sqro, fig.pos='H',out.width='\\textwidth',fig.show = "hold",fig.align='center',fig.show="hold", fig.cap="First Section, Square Orange", echo=FALSE, include=TRUE  }


sqroeq <- dataone %>%  filter(fraction_blue == 50) %>%  gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_sq_or","Ethnic" = "eth_sq_or"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid(circle_orange ~ rev_circle_blue + segregation, labeller = labeller(circle_orange = circle_orange.labs, rev_circle_blue = rev_circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Square orange, equal ethnic size") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )


sqroqmj <- dataone %>%  filter(fraction_blue == 80) %>%  gather(key = subgroup, value = Segra, eth_sq_or,val_sq_or) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_sq_or","Ethnic" = "eth_sq_or"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid(circle_orange ~ rev_circle_blue + segregation, labeller = labeller(circle_orange = circle_orange.labs, rev_circle_blue = rev_circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Square orange, ethnic minority") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )



sqroeq
sqroqmj
```


```{r crlbl,fig.pos='H' ,out.width='\\textwidth',fig.show = "hold",fig.align='center',fig.show="hold", fig.cap="First Section, Circle Blue", echo=FALSE, include=TRUE}


 rev_circle_orange.labs <-  c("80% Circle \nOrange", "50% Circle \nOrange","20% Circle \nOrange")
names(rev_circle_orange.labs) <- c("80", "50","20")

 circle_blue.labs <- c("20% Circle \nBlue", "50% Circle \nBlue","80% Circle \nBlue")
names(circle_blue.labs) <- c("20", "50","80")


crlbeq <- dataone %>%  filter(fraction_blue == 50) %>%  gather(key = subgroup, value = Segra, eth_cl_bl,val_cl_bl) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_cl_bl","Ethnic" = "eth_cl_bl"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid( rev_circle_blue  ~ circle_orange  + segregation, labeller = labeller(circle_orange =circle_orange.labs, rev_circle_blue = rev_circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Circle blue, equal ethnic size") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )


crlbmj <- dataone %>%  filter(fraction_blue == 80) %>%  gather(key = subgroup, value = Segra, eth_cl_bl,val_cl_bl) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_cl_bl","Ethnic" = "eth_cl_bl"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid( rev_circle_blue  ~ circle_orange  + segregation, labeller = labeller(circle_orange =circle_orange.labs, rev_circle_blue = rev_circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Circle blue, ethnic majority") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )


#grid.arrange(grob(sqroeq),grob(sqromj), ncol =  1, common.legend = TRUE,legend = "bottom") 

 crlbeq
 crlbmj
```


```{r sqrbl, fig.pos='H' ,out.width='\\textwidth',fig.show = "hold",fig.align='center',fig.show="hold", fig.cap="First Section, Square Blue", echo=FALSE, include=TRUE}


sqrbeq <- dataone %>%  filter(fraction_blue == 50) %>%  gather(key = subgroup, value = Segra, eth_sq_bl,val_sq_bl) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_sq_bl","Ethnic" = "eth_sq_bl"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid(circle_blue ~  rev_circle_orange  + segregation, labeller = labeller(rev_circle_orange = rev_circle_orange.labs, circle_blue = circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Square blue, equal ethnic size") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )


sqrbomj <- dataone %>%  filter(fraction_blue == 80) %>%  gather(key = subgroup, value = Segra, eth_sq_bl,val_sq_bl) %>% mutate(`segregation` = fct_relevel(fct_collapse(subgroup,"Value" = "val_sq_bl","Ethnic" = "eth_sq_bl"), "Value"))  %>% 
  ggplot(aes(x = beta_ie,y = beta_iv, fill = Segra)) + geom_tile() + 
  facet_grid(circle_blue ~  rev_circle_orange  + segregation, labeller = labeller(rev_circle_orange = rev_circle_orange.labs, circle_blue = circle_blue.labs), switch  = "y") +
  scale_fill_distiller(palette = "RdBu", limits=c(0,1), breaks=c(0,0.2,0.5,0.8,1)) +
  scale_x_discrete( limits=c(0,10, by = 5)) +
  scale_y_discrete( limits=c(0,10, by = 5), position = "right") +
  xlab("ß ethnic") + ylab("ß value") + ggtitle("Square blue, ethnic majority") + 
  theme_bw() +  theme(legend.position = "bottom", legend.title = element_blank(), panel.grid.minor.x = element_blank(), plot.title=element_text(hjust = 0.5),  legend.margin=margin(0,0,0,0), 
                      panel.spacing.x  = unit(0.2, "lines"),panel.spacing.y  = unit(0.1, "lines") )



sqrbeq
sqrbomj
```































